{% extends "admin_base.html" %}

{% block title %}Treinamento da IA - MIA Bot{% endblock %}

{% block page_title %}Treinamento da IA{% endblock %}
{% block page_subtitle %}Configure a personalidade, conhecimento e FAQs da MIA{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <h3>Base de Conhecimento</h3>
        <div class="stat-value" id="knowledge-count">{{ knowledge_count }}</div>
        <i class="fas fa-book stat-icon"></i>
    </div>
    <div class="stat-card">
        <h3>FAQs Cadastradas</h3>
        <div class="stat-value" id="faq-count">{{ faq_count }}</div>
        <i class="fas fa-question-circle stat-icon"></i>
    </div>
</div>

<!-- Se√ß√£o de Personalidade -->
<div class="card">
    <div class="card-header">
        <h2>üé≠ Personalidade da IA</h2>
        <p>Defina como a MIA deve se comportar nas conversas</p>
    </div>
    <div class="card-body">
        <form id="personality-form">
            <div class="form-group">
                <label for="tone">Tom de Voz</label>
                <select id="tone" name="tone" class="form-control">
                    <option value="friendly" {% if personality.get('tone') == 'friendly' %}selected{% endif %}>Amig√°vel e Casual</option>
                    <option value="professional" {% if personality.get('tone') == 'professional' %}selected{% endif %}>Profissional e Formal</option>
                    <option value="enthusiastic" {% if personality.get('tone') == 'enthusiastic' %}selected{% endif %}>Entusiasta e Energ√©tico</option>
                    <option value="empathetic" {% if personality.get('tone') == 'empathetic' %}selected{% endif %}>Emp√°tico e Acolhedor</option>
                </select>
            </div>

            <div class="form-group">
                <label for="goals">Objetivos da IA</label>
                <textarea id="goals" name="goals" class="form-control" rows="4" placeholder="Ex: Qualificar leads de tradu√ß√£o, agendar reuni√µes, fornecer informa√ß√µes sobre servi√ßos...">{{ personality.get('goals', '') if personality.get('goals') is string else '\n'.join(personality.get('goals', [])) }}</textarea>
                <p class="form-hint">Um objetivo por linha</p>
            </div>

            <div class="form-group">
                <label for="restrictions">Restri√ß√µes</label>
                <textarea id="restrictions" name="restrictions" class="form-control" rows="4" placeholder="Ex: N√£o fornecer or√ßamentos sem an√°lise, sempre transferir casos complexos para humano...">{{ personality.get('restrictions', '') if personality.get('restrictions') is string else '\n'.join(personality.get('restrictions', [])) }}</textarea>
                <p class="form-hint">Uma restri√ß√£o por linha</p>
            </div>

            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Salvar Personalidade
            </button>
        </form>
    </div>
</div>

<!-- Se√ß√£o de Base de Conhecimento -->
<div class="card">
    <div class="card-header">
        <h2>üìö Base de Conhecimento</h2>
        <p>Adicione informa√ß√µes que a IA deve saber</p>
    </div>
    <div class="card-body">
        <form id="knowledge-form">
            <input type="hidden" id="knowledge-edit-index" value="">
            <div class="form-group">
                <label for="knowledge-title">T√≠tulo</label>
                <input type="text" id="knowledge-title" name="title" class="form-control" placeholder="Ex: Servi√ßos de Tradu√ß√£o Juramentada">
            </div>

            <div class="form-group">
                <label for="knowledge-content">Conte√∫do</label>
                <textarea id="knowledge-content" name="content" class="form-control" rows="6" placeholder="Descreva as informa√ß√µes que a IA deve saber sobre este t√≥pico..."></textarea>
            </div>

            <button type="submit" class="btn btn-secondary" id="knowledge-submit-btn">
                <i class="fas fa-plus"></i> <span id="knowledge-btn-text">Adicionar Conhecimento</span>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="knowledge-cancel-btn" style="display: none;" onclick="cancelEditKnowledge()">
                <i class="fas fa-times"></i> Cancelar
            </button>
        </form>

        <div id="knowledge-list" style="margin-top: 32px;">
            <h3 style="color: var(--legacy-navy); margin-bottom: 16px;">Conhecimentos Cadastrados</h3>
            <div id="knowledge-items"></div>
        </div>
    </div>
</div>

<!-- Se√ß√£o de FAQs -->
<div class="card">
    <div class="card-header">
        <h2>‚ùì Perguntas Frequentes (FAQs)</h2>
        <p>Cadastre perguntas e respostas comuns</p>
    </div>
    <div class="card-body">
        <form id="faq-form">
            <input type="hidden" id="faq-edit-index" value="">
            <div class="form-group">
                <label for="faq-question">Pergunta</label>
                <input type="text" id="faq-question" name="question" class="form-control" placeholder="Ex: Quanto tempo leva uma tradu√ß√£o?">
            </div>

            <div class="form-group">
                <label for="faq-answer">Resposta</label>
                <textarea id="faq-answer" name="answer" class="form-control" rows="4" placeholder="Resposta que a IA deve dar..."></textarea>
            </div>

            <button type="submit" class="btn btn-secondary" id="faq-submit-btn">
                <i class="fas fa-plus"></i> <span id="faq-btn-text">Adicionar FAQ</span>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="faq-cancel-btn" style="display: none;" onclick="cancelEditFAQ()">
                <i class="fas fa-times"></i> Cancelar
            </button>
        </form>

        <div id="faq-list" style="margin-top: 32px;">
            <h3 style="color: var(--legacy-navy); margin-bottom: 16px;">FAQs Cadastradas</h3>
            <div id="faq-items"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const BOT_ID = "{{ bot_id }}";

// ============================================================
// PERSONALIDADE
// ============================================================
$('#personality-form').on('submit', async function(e) {
    e.preventDefault();
    
    const goals = $('#goals').val().split('\n').filter(g => g.trim());
    const restrictions = $('#restrictions').val().split('\n').filter(r => r.trim());
    
    const data = {
        personality: {
            tone: $('#tone').val(),
            goals: goals,
            restrictions: restrictions
        }
    };
    
    try {
        const response = await fetch(`/admin/treinamento/api/personality/${BOT_ID}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ Personalidade salva com sucesso!');
        } else {
            alert('‚ùå Erro ao salvar: ' + result.message);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro ao salvar personalidade');
    }
});

// ============================================================
// BASE DE CONHECIMENTO
// ============================================================
$('#knowledge-form').on('submit', async function(e) {
    e.preventDefault();
    
    const editIndex = $('#knowledge-edit-index').val();
    const data = {
        title: $('#knowledge-title').val(),
        content: $('#knowledge-content').val()
    };
    
    if (!data.title || !data.content) {
        alert('‚ö†Ô∏è Preencha todos os campos');
        return;
    }
    
    try {
        let url = `/admin/treinamento/api/knowledge/${BOT_ID}`;
        let method = 'POST';
        
        // Se est√° editando
        if (editIndex !== '') {
            url = `/admin/treinamento/api/knowledge/${BOT_ID}/${editIndex}`;
            method = 'PUT';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(editIndex !== '' ? '‚úÖ Conhecimento atualizado!' : '‚úÖ Conhecimento adicionado!');
            $('#knowledge-title').val('');
            $('#knowledge-content').val('');
            $('#knowledge-edit-index').val('');
            $('#knowledge-btn-text').text('Adicionar Conhecimento');
            $('#knowledge-submit-btn i').attr('class', 'fas fa-plus');
            $('#knowledge-cancel-btn').hide();
            loadKnowledge();
            updateCounts();
        } else {
            alert('‚ùå Erro: ' + result.message);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro ao salvar conhecimento');
    }
});

function editKnowledge(index) {
    fetch(`/admin/treinamento/api/knowledge/${BOT_ID}`)
        .then(res => res.json())
        .then(result => {
            if (result.success && result.knowledge[index]) {
                const item = result.knowledge[index];
                $('#knowledge-title').val(item.title);
                $('#knowledge-content').val(item.content);
                $('#knowledge-edit-index').val(index);
                $('#knowledge-btn-text').text('Atualizar Conhecimento');
                $('#knowledge-submit-btn i').attr('class', 'fas fa-save');
                $('#knowledge-cancel-btn').show();
                
                // Scroll para o formul√°rio
                $('html, body').animate({
                    scrollTop: $('#knowledge-form').offset().top - 100
                }, 500);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('‚ùå Erro ao carregar conhecimento');
        });
}

function cancelEditKnowledge() {
    $('#knowledge-title').val('');
    $('#knowledge-content').val('');
    $('#knowledge-edit-index').val('');
    $('#knowledge-btn-text').text('Adicionar Conhecimento');
    $('#knowledge-submit-btn i').attr('class', 'fas fa-plus');
    $('#knowledge-cancel-btn').hide();
}

async function loadKnowledge() {
    try {
        const response = await fetch(`/admin/treinamento/api/knowledge/${BOT_ID}`);
        const result = await response.json();
        
        if (result.success && result.knowledge.length > 0) {
            const html = result.knowledge.map((item, index) => `
                <div class="card" style="margin-bottom: 16px;">
                    <div class="card-body">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h4 style="color: var(--legacy-navy); margin-bottom: 8px;">${item.title}</h4>
                                <p style="color: var(--gray-600); margin: 0;">${item.content}</p>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-warning btn-sm" onclick="editKnowledge(${index})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteKnowledge(${index})" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            $('#knowledge-items').html(html);
        } else {
            $('#knowledge-items').html('<p style="color: var(--gray-500);">Nenhum conhecimento cadastrado ainda.</p>');
        }
    } catch (error) {
        console.error('Erro ao carregar conhecimento:', error);
    }
}

async function deleteKnowledge(index) {
    if (!confirm('Tem certeza que deseja excluir este conhecimento?')) return;
    
    try {
        const response = await fetch(`/admin/treinamento/api/knowledge/${BOT_ID}/${index}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ Conhecimento exclu√≠do!');
            loadKnowledge();
            updateCounts();
        } else {
            alert('‚ùå Erro ao excluir');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro ao excluir conhecimento');
    }
}

// ============================================================
// FAQs
// ============================================================
$('#faq-form').on('submit', async function(e) {
    e.preventDefault();
    
    const editIndex = $('#faq-edit-index').val();
    const data = {
        question: $('#faq-question').val(),
        answer: $('#faq-answer').val()
    };
    
    if (!data.question || !data.answer) {
        alert('‚ö†Ô∏è Preencha todos os campos');
        return;
    }
    
    try {
        let url = `/admin/treinamento/api/faq/${BOT_ID}`;
        let method = 'POST';
        
        // Se est√° editando
        if (editIndex !== '') {
            url = `/admin/treinamento/api/faq/${BOT_ID}/${editIndex}`;
            method = 'PUT';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(editIndex !== '' ? '‚úÖ FAQ atualizada!' : '‚úÖ FAQ adicionada!');
            $('#faq-question').val('');
            $('#faq-answer').val('');
            $('#faq-edit-index').val('');
            $('#faq-btn-text').text('Adicionar FAQ');
            $('#faq-submit-btn i').attr('class', 'fas fa-plus');
            $('#faq-cancel-btn').hide();
            loadFAQs();
            updateCounts();
        } else {
            alert('‚ùå Erro: ' + result.message);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro ao salvar FAQ');
    }
});

function editFAQ(index) {
    fetch(`/admin/treinamento/api/faq/${BOT_ID}`)
        .then(res => res.json())
        .then(result => {
            if (result.success && result.faqs[index]) {
                const item = result.faqs[index];
                $('#faq-question').val(item.question);
                $('#faq-answer').val(item.answer);
                $('#faq-edit-index').val(index);
                $('#faq-btn-text').text('Atualizar FAQ');
                $('#faq-submit-btn i').attr('class', 'fas fa-save');
                $('#faq-cancel-btn').show();
                
                // Scroll para o formul√°rio
                $('html, body').animate({
                    scrollTop: $('#faq-form').offset().top - 100
                }, 500);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('‚ùå Erro ao carregar FAQ');
        });
}

function cancelEditFAQ() {
    $('#faq-question').val('');
    $('#faq-answer').val('');
    $('#faq-edit-index').val('');
    $('#faq-btn-text').text('Adicionar FAQ');
    $('#faq-submit-btn i').attr('class', 'fas fa-plus');
    $('#faq-cancel-btn').hide();
}

async function loadFAQs() {
    try {
        const response = await fetch(`/admin/treinamento/api/faq/${BOT_ID}`);
        const result = await response.json();
        
        if (result.success && result.faqs.length > 0) {
            const html = result.faqs.map((item, index) => `
                <div class="card" style="margin-bottom: 16px;">
                    <div class="card-body">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h4 style="color: var(--legacy-navy); margin-bottom: 8px;">‚ùì ${item.question}</h4>
                                <p style="color: var(--gray-600); margin: 0;">üí¨ ${item.answer}</p>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-warning btn-sm" onclick="editFAQ(${index})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteFAQ(${index})" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            $('#faq-items').html(html);
        } else {
            $('#faq-items').html('<p style="color: var(--gray-500);">Nenhuma FAQ cadastrada ainda.</p>');
        }
    } catch (error) {
        console.error('Erro ao carregar FAQs:', error);
    }
}

async function deleteFAQ(index) {
    if (!confirm('Tem certeza que deseja excluir esta FAQ?')) return;
    
    try {
        const response = await fetch(`/admin/treinamento/api/faq/${BOT_ID}/${index}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ FAQ exclu√≠da!');
            loadFAQs();
            updateCounts();
        } else {
            alert('‚ùå Erro ao excluir');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro ao excluir FAQ');
    }
}

// ============================================================
// ATUALIZAR CONTADORES
// ============================================================
async function updateCounts() {
    try {
        const [knowledgeRes, faqRes] = await Promise.all([
            fetch(`/admin/treinamento/api/knowledge/${BOT_ID}`),
            fetch(`/admin/treinamento/api/faq/${BOT_ID}`)
        ]);
        
        const knowledge = await knowledgeRes.json();
        const faqs = await faqRes.json();
        
        $('#knowledge-count').text(knowledge.knowledge?.length || 0);
        $('#faq-count').text(faqs.faqs?.length || 0);
    } catch (error) {
        console.error('Erro ao atualizar contadores:', error);
    }
}

// Carregar dados ao iniciar
$(document).ready(function() {
    loadKnowledge();
    loadFAQs();
});
</script>
{% endblock %}
