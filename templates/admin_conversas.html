{% extends "admin_base.html" %}

{% block title %}Conversions & Reports - MIA Admin{% endblock %}

{% block extra_style %}
<style>
    /* ============================================
       LAYOUT PROFISSIONAL - FONTES MENORES
       ============================================ */

    .page-header h1 {
        font-size: 1.4em;
        color: #1e3a5f;
        margin-bottom: 5px;
    }

    .page-header p {
        font-size: 0.85em;
        color: #666;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .periodo-selector {
        display: flex;
        gap: 6px;
        align-items: center;
    }

    .periodo-btn {
        padding: 5px 12px;
        border: 1px solid #e0e0e0;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.75em;
        transition: all 0.2s;
    }

    .periodo-btn.active {
        background: #5dade2;
        color: white;
        border-color: #5dade2;
    }

    .periodo-btn:hover {
        border-color: #5dade2;
    }

    .resumo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-bottom: 15px;
    }

    .resumo-card {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        text-align: center;
        border: 1px solid #e9ecef;
    }

    .resumo-card.destaque {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }

    .resumo-label {
        font-size: 0.7em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.8;
        margin-bottom: 5px;
    }

    .resumo-valor {
        font-size: 1.5em;
        font-weight: bold;
    }

    .resumo-sub {
        font-size: 0.7em;
        opacity: 0.7;
        margin-top: 3px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
    }

    .stat-card {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 12px;
        border: 1px solid #e9ecef;
        border-left: 3px solid;
    }

    .stat-card.conversoes { border-left-color: #27ae60; }
    .stat-card.clientes { border-left-color: #3498db; }
    .stat-card.ia { border-left-color: #9b59b6; }
    .stat-card.humano { border-left-color: #f39c12; }
    .stat-card.taxa { border-left-color: #e74c3c; }

    .stat-label {
        font-size: 0.65em;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .stat-value {
        font-size: 1.3em;
        font-weight: bold;
        color: #1e3a5f;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .chart-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-left: 3px solid #5dade2;
    }

    .chart-title {
        font-size: 0.85em;
        font-weight: 600;
        color: #1e3a5f;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .section-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 15px;
        border-left: 3px solid #5dade2;
    }

    .section-card.warning {
        border-left-color: #f39c12;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f0f0;
    }

    .section-title {
        font-size: 0.9em;
        font-weight: 600;
        color: #1e3a5f;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .table-container {
        overflow-x: auto;
        max-height: 300px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8em;
    }

    .data-table th {
        background: #f8f9fa;
        padding: 8px 10px;
        text-align: left;
        font-weight: 600;
        color: #1e3a5f;
        border-bottom: 1px solid #e0e0e0;
        font-size: 0.85em;
        position: sticky;
        top: 0;
    }

    .data-table td {
        padding: 8px 10px;
        border-bottom: 1px solid #f0f0f0;
    }

    .data-table tr:hover {
        background: #f8f9fa;
    }

    .badge {
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 0.7em;
        font-weight: 600;
    }

    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-danger { background: #f8d7da; color: #721c24; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .badge-ia { background: #e8daef; color: #6c3483; }
    .badge-humano { background: #fdebd0; color: #b9770e; }

    .prioridade-high { background: #f8d7da; color: #721c24; }
    .prioridade-medium { background: #fff3cd; color: #856404; }
    .prioridade-low { background: #d4edda; color: #155724; }

    .btn-action {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.7em;
        transition: all 0.2s;
        margin-right: 3px;
    }

    .btn-whatsapp { background: #25d366; color: white; }
    .btn-whatsapp:hover { background: #1da851; }
    .btn-edit { background: #5dade2; color: white; }
    .btn-edit:hover { background: #4a9dd1; }
    .btn-delete { background: #e74c3c; color: white; }
    .btn-delete:hover { background: #c0392b; }

    .btn-registrar {
        background: #27ae60;
        color: white;
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.75em;
    }

    .btn-registrar:hover {
        background: #229954;
    }

    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        padding: 20px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        font-size: 1em;
        font-weight: 600;
        color: #1e3a5f;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f0f0;
    }

    .form-group {
        margin-bottom: 12px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #444;
        margin-bottom: 5px;
        font-size: 0.8em;
    }

    .form-input, .form-textarea {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        font-size: 0.85em;
        box-sizing: border-box;
    }

    .form-input:focus, .form-textarea:focus {
        outline: none;
        border-color: #5dade2;
    }

    .form-textarea {
        min-height: 60px;
        resize: vertical;
    }

    .status-buttons {
        display: flex;
        gap: 6px;
        margin-bottom: 12px;
    }

    .status-btn {
        flex: 1;
        padding: 8px;
        border: 1px solid #e0e0e0;
        background: white;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.75em;
        transition: all 0.2s;
    }

    .status-btn.active-converted { background: #d4edda; border-color: #27ae60; color: #155724; }
    .status-btn.active-no { background: #f8d7da; border-color: #e74c3c; color: #721c24; }
    .status-btn.active-pending { background: #fff3cd; border-color: #f39c12; color: #856404; }

    .modal-buttons {
        display: flex;
        gap: 8px;
        margin-top: 15px;
    }

    .btn-cancel {
        flex: 1;
        padding: 8px;
        background: #e0e0e0;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.8em;
    }

    .btn-confirm {
        flex: 1;
        padding: 8px;
        background: #27ae60;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.8em;
    }

    .empty-state {
        text-align: center;
        padding: 20px;
        color: #666;
        font-size: 0.85em;
    }

    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        border-left: 3px solid #e74c3c;
        font-size: 0.85em;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 12px;
        font-size: 0.85em;
    }

    .checkbox-group input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
    }

    @media (max-width: 768px) {
        .charts-grid { grid-template-columns: 1fr; }
        .status-buttons { flex-direction: column; }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="page-header" style="margin-bottom: 0;">
        <h1>Conversions & Reports</h1>
        <p>Track sales, leads and conversion rate</p>
    </div>
    <div class="periodo-selector">
        <span style="font-weight: 600; color: #666; font-size: 0.8em;">Period:</span>
        <button class="periodo-btn" data-periodo="7" onclick="setPeriodo(7)">7d</button>
        <button class="periodo-btn active" data-periodo="15" onclick="setPeriodo(15)">15d</button>
        <button class="periodo-btn" data-periodo="30" onclick="setPeriodo(30)">30d</button>
    </div>
</div>

<div id="error-container" style="display: none;"></div>

<div class="resumo-grid">
    <div class="resumo-card destaque">
        <div class="resumo-label">Period Revenue</div>
        <div class="resumo-valor" id="valor-total">$0</div>
        <div class="resumo-sub" id="conversoes-total">0 conversions</div>
    </div>
    <div class="resumo-card">
        <div class="resumo-label">Conversion Rate</div>
        <div class="resumo-valor" id="taxa-conversao">0%</div>
        <div class="resumo-sub">clients to sales</div>
    </div>
    <div class="resumo-card">
        <div class="resumo-label">Leads for Follow-up</div>
        <div class="resumo-valor" id="leads-followup">0</div>
        <div class="resumo-sub">did not convert</div>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card conversoes">
        <div class="stat-label">Conversions</div>
        <div class="stat-value" id="stat-conversoes">0</div>
    </div>
    <div class="stat-card clientes">
        <div class="stat-label">Clients</div>
        <div class="stat-value" id="stat-clientes">0</div>
    </div>
    <div class="stat-card ia">
        <div class="stat-label">AI (min)</div>
        <div class="stat-value" id="stat-ia">0</div>
    </div>
    <div class="stat-card humano">
        <div class="stat-label">Human (min)</div>
        <div class="stat-value" id="stat-humano">0</div>
    </div>
    <div class="stat-card taxa">
        <div class="stat-label">Rate</div>
        <div class="stat-value" id="stat-taxa">0%</div>
    </div>
</div>

<div class="charts-grid">
    <div class="chart-card">
        <div class="chart-title">Conversions per Day</div>
        <canvas id="chartConversoes" height="150"></canvas>
    </div>
    <div class="chart-card">
        <div class="chart-title">AI vs Human (Support)</div>
        <canvas id="chartAtendimentos" height="150"></canvas>
    </div>
</div>

<div class="section-card">
    <div class="section-header">
        <div class="section-title">Recent Conversions</div>
        <button class="btn-registrar" onclick="abrirModalConversao()">+ Add Conversion</button>
    </div>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Value</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Type</th>
                    <th>Detection</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="conversoes-body">
                <tr><td colspan="7" class="empty-state">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="section-card warning">
    <div class="section-header">
        <div class="section-title">Leads for Follow-up</div>
        <button class="btn-registrar" onclick="abrirModalLead()">+ Add Lead</button>
    </div>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Last Contact</th>
                    <th>Msgs</th>
                    <th>Inactive</th>
                    <th>Quote</th>
                    <th>Priority</th>
                    <th>Result</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="leads-body">
                <tr><td colspan="8" class="empty-state">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Conversao -->
<div class="modal-overlay" id="modal-conversao">
    <div class="modal-content">
        <div class="modal-header">Add New Conversion</div>
        <div class="form-group">
            <label class="form-label">Client Phone</label>
            <input type="text" class="form-input" id="conv-phone" placeholder="18572081139">
        </div>
        <div class="form-group">
            <label class="form-label">Value ($)</label>
            <input type="number" class="form-input" id="conv-valor" placeholder="150.00" step="0.01">
        </div>
        <div class="form-group">
            <label class="form-label">Notes</label>
            <input type="text" class="form-input" id="conv-obs" placeholder="Certificate translation">
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="fecharModal('modal-conversao')">Cancel</button>
            <button class="btn-confirm" onclick="registrarConversao()">Save</button>
        </div>
    </div>
</div>

<!-- Modal Edit Conversao -->
<div class="modal-overlay" id="modal-edit-conversao">
    <div class="modal-content">
        <div class="modal-header">Edit Conversion</div>
        <input type="hidden" id="edit-conv-id">
        <div class="form-group">
            <label class="form-label">Client Phone</label>
            <input type="text" class="form-input" id="edit-conv-phone" placeholder="18572081139">
        </div>
        <div class="form-group">
            <label class="form-label">Value ($)</label>
            <input type="number" class="form-input" id="edit-conv-valor" placeholder="150.00" step="0.01">
        </div>
        <div class="form-group">
            <label class="form-label">Notes</label>
            <input type="text" class="form-input" id="edit-conv-obs" placeholder="Certificate translation">
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="fecharModal('modal-edit-conversao')">Cancel</button>
            <button class="btn-confirm" onclick="salvarEditConversao()">Save</button>
        </div>
    </div>
</div>

<!-- Modal Lead -->
<div class="modal-overlay" id="modal-lead">
    <div class="modal-content">
        <div class="modal-header">Add New Lead</div>
        <div class="form-group">
            <label class="form-label">Client Phone</label>
            <input type="text" class="form-input" id="lead-phone" placeholder="18572081139">
        </div>
        <div class="form-group">
            <label class="form-label">Last Contact Date</label>
            <input type="date" class="form-input" id="lead-date">
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="lead-asked-quote">
            <label for="lead-asked-quote">Asked for Quote?</label>
        </div>
        <div class="form-group">
            <label class="form-label">Priority</label>
            <select class="form-input" id="lead-priority">
                <option value="High">High</option>
                <option value="Medium" selected>Medium</option>
                <option value="Low">Low</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Result</label>
            <div class="status-buttons">
                <button class="status-btn" id="status-pending" onclick="setLeadStatus('pending')">Pending</button>
                <button class="status-btn" id="status-converted" onclick="setLeadStatus('converted')">Converted</button>
                <button class="status-btn" id="status-no" onclick="setLeadStatus('no')">No</button>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Reason / Notes</label>
            <textarea class="form-textarea" id="lead-reason" placeholder="Notes..."></textarea>
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="fecharModal('modal-lead')">Cancel</button>
            <button class="btn-confirm" onclick="salvarLead()">Save</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var periodo = 15;
    var chartConversoes = null;
    var chartAtendimentos = null;
    var leadStatusSelected = 'pending';

    window.onload = function() {
        carregarDados();
        document.getElementById('lead-date').valueAsDate = new Date();
        setLeadStatus('pending');
    };

    function mostrarErro(msg) {
        var c = document.getElementById('error-container');
        c.innerHTML = '<div class="error-message">' + msg + '</div>';
        c.style.display = 'block';
        setTimeout(function() { c.style.display = 'none'; }, 5000);
    }

    function setPeriodo(dias) {
        periodo = dias;
        document.querySelectorAll('.periodo-btn').forEach(function(btn) {
            btn.classList.remove('active');
            if (btn.dataset.periodo == dias) btn.classList.add('active');
        });
        carregarDados();
    }

    function carregarDados() {
        carregarStats();
        carregarCharts();
        carregarConversoes();
        carregarLeads();
    }

    function carregarStats() {
        fetch('/admin/conversas/api/stats?periodo=' + periodo)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) return;
                document.getElementById('valor-total').textContent = '$' + (data.valor_total || 0);
                document.getElementById('conversoes-total').textContent = (data.total_conversoes || 0) + ' conversions';
                document.getElementById('taxa-conversao').textContent = (data.taxa_conversao || 0) + '%';
                document.getElementById('leads-followup').textContent = data.leads_followup || 0;
                document.getElementById('stat-conversoes').textContent = data.conversoes || 0;
                document.getElementById('stat-clientes').textContent = data.clientes_unicos || 0;
                document.getElementById('stat-ia').textContent = data.tempo_ia_minutos || 0;
                document.getElementById('stat-humano').textContent = data.tempo_humano_minutos || 0;
                document.getElementById('stat-taxa').textContent = (data.taxa_conversao_stat || 0) + '%';
            }).catch(function(e) { console.error(e); });
    }

    function carregarCharts() {
        fetch('/admin/conversas/api/chart-data?periodo=' + periodo)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) return;
                var labels = data.labels.map(function(d) {
                    var date = new Date(d);
                    return (date.getMonth()+1) + '/' + date.getDate();
                });
                var ctxConv = document.getElementById('chartConversoes').getContext('2d');
                if (chartConversoes) chartConversoes.destroy();
                chartConversoes = new Chart(ctxConv, {
                    type: 'bar',
                    data: { labels: labels, datasets: [{ label: 'Conversions', data: data.conversoes, backgroundColor: 'rgba(39, 174, 96, 0.8)' }] },
                    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
                var ctxAtend = document.getElementById('chartAtendimentos').getContext('2d');
                if (chartAtendimentos) chartAtendimentos.destroy();
                chartAtendimentos = new Chart(ctxAtend, {
                    type: 'line',
                    data: { labels: labels, datasets: [
                        { label: 'AI', data: data.atendimentos_ia, borderColor: 'rgba(155, 89, 182, 1)', backgroundColor: 'rgba(155, 89, 182, 0.1)', fill: true },
                        { label: 'Human', data: data.atendimentos_humano, borderColor: 'rgba(243, 156, 18, 1)', backgroundColor: 'rgba(243, 156, 18, 0.1)', fill: true }
                    ] },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            }).catch(function(e) { console.error(e); });
    }

    function carregarConversoes() {
        fetch('/admin/conversas/api/conversoes?periodo=' + periodo)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var tbody = document.getElementById('conversoes-body');
                if (!data.conversoes || data.conversoes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No conversions</td></tr>';
                    return;
                }
                var html = '';
                data.conversoes.forEach(function(c) {
                    var msg = (c.message || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    html += '<tr><td><strong>' + c.phone + '</strong></td><td style="color:#27ae60;font-weight:bold;">$' + c.valor + '</td><td>' + c.timestamp + '</td><td>' + c.tempo_atendimento + '</td><td><span class="badge badge-ia">' + c.tipo_atendimento + '</span></td><td><span class="badge badge-info">' + c.metodo + '</span></td><td><button class="btn-action btn-edit" onclick="abrirEditConversao(\'' + c.id + '\', \'' + c.phone + '\', ' + c.valor + ', \'' + msg + '\')">‚úèÔ∏è</button> <button class="btn-action btn-delete" onclick="deletarConversao(\'' + c.id + '\')">üóëÔ∏è</button></td></tr>';
                });
                tbody.innerHTML = html;
            }).catch(function(e) { console.error(e); });
    }

    function carregarLeads() {
        fetch('/admin/conversas/api/leads-followup')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var tbody = document.getElementById('leads-body');
                if (!data.leads || data.leads.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No leads</td></tr>';
                    return;
                }
                var html = '';
                data.leads.forEach(function(l) {
                    var priClass = 'prioridade-' + l.priority.toLowerCase();
                    var statusBadge = l.status === 'converted' ? '<span class="badge badge-success">Yes</span>' : l.status === 'no' ? '<span class="badge badge-danger">No</span>' : '<span class="badge badge-warning">Pending</span>';
                    html += '<tr><td><strong>' + l.phone + '</strong></td><td>' + l.last_contact + '</td><td>' + l.total_msgs + '</td><td>' + l.dias_sem_contato + 'd</td><td>' + l.asked_quote + '</td><td><span class="badge ' + priClass + '">' + l.priority + '</span></td><td>' + statusBadge + '</td><td><button class="btn-action btn-whatsapp" onclick="abrirWhatsApp(\'' + l.phone + '\')">üì±</button><button class="btn-action btn-delete" onclick="deletarLead(\'' + l.id + '\')">üóë</button></td></tr>';
                });
                tbody.innerHTML = html;
            }).catch(function(e) { console.error(e); });
    }

    function abrirWhatsApp(phone) { window.open('https://wa.me/' + phone, '_blank'); }
    function abrirModalConversao() { document.getElementById('modal-conversao').style.display = 'flex'; }
    function abrirModalLead() {
        document.getElementById('modal-lead').style.display = 'flex';
        document.getElementById('lead-phone').value = '';
        document.getElementById('lead-date').valueAsDate = new Date();
        setLeadStatus('pending');
    }
    function fecharModal(id) { document.getElementById(id).style.display = 'none'; }

    function setLeadStatus(status) {
        leadStatusSelected = status;
        document.getElementById('status-pending').classList.remove('active-pending');
        document.getElementById('status-converted').classList.remove('active-converted');
        document.getElementById('status-no').classList.remove('active-no');
        if (status === 'pending') document.getElementById('status-pending').classList.add('active-pending');
        else if (status === 'converted') document.getElementById('status-converted').classList.add('active-converted');
        else if (status === 'no') document.getElementById('status-no').classList.add('active-no');
    }

    function salvarLead() {
        var phone = document.getElementById('lead-phone').value;
        if (!phone) { alert('Enter phone'); return; }
        fetch('/admin/conversas/api/add-lead', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phone, last_contact_date: document.getElementById('lead-date').value, asked_quote: document.getElementById('lead-asked-quote').checked, priority: document.getElementById('lead-priority').value, status: leadStatusSelected, notes: document.getElementById('lead-reason').value })
        }).then(function(r) { return r.json(); }).then(function(data) {
            if (data.success) { alert('Lead saved!'); fecharModal('modal-lead'); carregarDados(); }
            else alert('Error: ' + data.error);
        }).catch(function(e) { alert('Error'); });
    }

    function registrarConversao() {
        var phone = document.getElementById('conv-phone').value;
        var valor = document.getElementById('conv-valor').value;
        if (!phone || !valor) { alert('Fill phone and value'); return; }
        fetch('/admin/conversas/api/registrar-conversao', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phone, valor: valor, observacao: document.getElementById('conv-obs').value })
        }).then(function(r) { return r.json(); }).then(function(data) {
            if (data.success) { alert('Conversion saved!'); fecharModal('modal-conversao'); carregarDados(); }
            else alert('Error: ' + data.error);
        }).catch(function(e) { alert('Error'); });
    }

    function deletarLead(id) {
        if (!confirm('Delete?')) return;
        fetch('/admin/conversas/api/delete-lead/' + id, { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) { if (data.success) carregarDados(); });
    }

    function abrirEditConversao(id, phone, valor, obs) {
        document.getElementById('edit-conv-id').value = id;
        document.getElementById('edit-conv-phone').value = phone;
        document.getElementById('edit-conv-valor').value = valor;
        document.getElementById('edit-conv-obs').value = obs;
        document.getElementById('modal-edit-conversao').style.display = 'flex';
    }

    function salvarEditConversao() {
        var id = document.getElementById('edit-conv-id').value;
        var phone = document.getElementById('edit-conv-phone').value;
        var valor = document.getElementById('edit-conv-valor').value;
        if (!phone || !valor) { alert('Fill phone and value'); return; }
        fetch('/admin/conversas/api/edit-conversao/' + id, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phone, valor: valor, observacao: document.getElementById('edit-conv-obs').value })
        }).then(function(r) { return r.json(); }).then(function(data) {
            if (data.success) { alert('Conversion updated!'); fecharModal('modal-edit-conversao'); carregarDados(); }
            else alert('Error: ' + (data.error || 'Unknown error'));
        }).catch(function(e) { alert('Error updating'); });
    }

    function deletarConversao(id) {
        if (!confirm('Delete this conversion?')) return;
        fetch('/admin/conversas/api/delete-conversao/' + id, { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    carregarDados();
                    alert('Conversion deleted!');
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            }).catch(function(e) { alert('Error deleting'); });
    }
</script>
{% endblock %}
