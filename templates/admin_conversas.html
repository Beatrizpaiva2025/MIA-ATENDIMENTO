{% extends "admin_base.html" %}

{% block title %}Conversoes e Relatorios - MIA Admin{% endblock %}

{% block extra_style %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .periodo-selector {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .periodo-btn {
        padding: 8px 16px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .periodo-btn.active {
        background: #5dade2;
        color: white;
        border-color: #5dade2;
    }

    .periodo-btn:hover {
        border-color: #5dade2;
    }

    .resumo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .resumo-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
    }

    .resumo-card.destaque {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .resumo-label {
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.8;
        margin-bottom: 8px;
    }

    .resumo-valor {
        font-size: 2em;
        font-weight: bold;
    }

    .resumo-sub {
        font-size: 0.9em;
        opacity: 0.7;
        margin-top: 5px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid;
    }

    .stat-card.conversoes { border-left-color: #27ae60; }
    .stat-card.clientes { border-left-color: #3498db; }
    .stat-card.ia { border-left-color: #9b59b6; }
    .stat-card.humano { border-left-color: #f39c12; }
    .stat-card.taxa { border-left-color: #e74c3c; }

    .stat-label {
        font-size: 0.85em;
        color: #7f8c8d;
        text-transform: uppercase;
        margin-bottom: 8px;
    }

    .stat-value {
        font-size: 1.8em;
        font-weight: bold;
        color: #1e3a5f;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .chart-title {
        font-size: 1.1em;
        font-weight: 600;
        color: #1e3a5f;
        margin-bottom: 20px;
    }

    .section-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .section-title {
        font-size: 1.2em;
        font-weight: 600;
        color: #1e3a5f;
    }

    .table-container {
        overflow-x: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        background: #f8f9fa;
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        color: #1e3a5f;
        border-bottom: 2px solid #e0e0e0;
        font-size: 0.9em;
    }

    .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.95em;
    }

    .data-table tr:hover {
        background: #f8f9fa;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
    }

    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .badge-ia { background: #e8daef; color: #6c3483; }
    .badge-humano { background: #fdebd0; color: #b9770e; }

    .prioridade-alta { background: #f8d7da; color: #721c24; }
    .prioridade-media { background: #fff3cd; color: #856404; }
    .prioridade-baixa { background: #d4edda; color: #155724; }

    .btn-action {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85em;
        transition: all 0.3s;
    }

    .btn-whatsapp {
        background: #25d366;
        color: white;
    }

    .btn-whatsapp:hover {
        background: #1da851;
    }

    .btn-registrar {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }

    .btn-registrar:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
    }

    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 30px;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
        font-size: 1.3em;
        font-weight: 600;
        color: #1e3a5f;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #1e3a5f;
        margin-bottom: 8px;
    }

    .form-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        box-sizing: border-box;
    }

    .form-input:focus {
        outline: none;
        border-color: #5dade2;
    }

    .modal-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-cancel {
        flex: 1;
        padding: 12px;
        background: #e0e0e0;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }

    .btn-confirm {
        flex: 1;
        padding: 12px;
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
    }

    @media (max-width: 768px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div>
        <h1>Conversoes e Relatorios</h1>
        <p>Acompanhe vendas, leads e melhore sua conversao</p>
    </div>
    <div class="periodo-selector">
        <span style="font-weight: 600; color: #7f8c8d;">Periodo:</span>
        <button class="periodo-btn" data-periodo="7" onclick="setPeriodo(7)">7 dias</button>
        <button class="periodo-btn active" data-periodo="15" onclick="setPeriodo(15)">15 dias</button>
        <button class="periodo-btn" data-periodo="30" onclick="setPeriodo(30)">30 dias</button>
    </div>
</div>

<div class="resumo-grid">
    <div class="resumo-card destaque">
        <div class="resumo-label">Faturamento do Periodo</div>
        <div class="resumo-valor" id="valor-total">$0</div>
        <div class="resumo-sub" id="conversoes-total">0 conversoes</div>
    </div>
    <div class="resumo-card">
        <div class="resumo-label">Taxa de Conversao</div>
        <div class="resumo-valor" id="taxa-conversao">0%</div>
        <div class="resumo-sub">clientes para vendas</div>
    </div>
    <div class="resumo-card">
        <div class="resumo-label">Clientes Atendidos</div>
        <div class="resumo-valor" id="clientes-unicos">0</div>
        <div class="resumo-sub" id="total-msgs">0 mensagens</div>
    </div>
    <div class="resumo-card">
        <div class="resumo-label">Leads para Follow-up</div>
        <div class="resumo-valor" id="leads-followup">0</div>
        <div class="resumo-sub">nao converteram</div>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card conversoes">
        <div class="stat-label">Conversoes</div>
        <div class="stat-value" id="stat-conversoes">0</div>
    </div>
    <div class="stat-card clientes">
        <div class="stat-label">Clientes</div>
        <div class="stat-value" id="stat-clientes">0</div>
    </div>
    <div class="stat-card ia">
        <div class="stat-label">Atend. IA</div>
        <div class="stat-value" id="stat-ia">0</div>
    </div>
    <div class="stat-card humano">
        <div class="stat-label">Atend. Humano</div>
        <div class="stat-value" id="stat-humano">0</div>
    </div>
    <div class="stat-card taxa">
        <div class="stat-label">Taxa Conv.</div>
        <div class="stat-value" id="stat-taxa">0%</div>
    </div>
</div>

<div class="charts-grid">
    <div class="chart-card">
        <div class="chart-title">Conversoes por Dia</div>
        <canvas id="chartConversoes"></canvas>
    </div>
    <div class="chart-card">
        <div class="chart-title">IA vs Humano (Atendimentos)</div>
        <canvas id="chartAtendimentos"></canvas>
    </div>
</div>

<div class="section-card">
    <div class="section-header">
        <div class="section-title">Conversoes Recentes</div>
        <button class="btn-registrar" onclick="abrirModalConversao()">+ Registrar Conversao</button>
    </div>
    <div class="table-container">
        <table class="data-table" id="tabela-conversoes">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Valor</th>
                    <th>Data</th>
                    <th>Tempo Atend.</th>
                    <th>Tipo</th>
                    <th>Deteccao</th>
                </tr>
            </thead>
            <tbody id="conversoes-body">
                <tr><td colspan="6" class="empty-state">Carregando...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="section-card">
    <div class="section-header">
        <div class="section-title">Leads para Follow-up (Nao Converteram)</div>
    </div>
    <div class="table-container">
        <table class="data-table" id="tabela-leads">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Ultima Msg</th>
                    <th>Msgs</th>
                    <th>Dias s/ Contato</th>
                    <th>Pediu Orcamento</th>
                    <th>Prioridade</th>
                    <th>Acao</th>
                </tr>
            </thead>
            <tbody id="leads-body">
                <tr><td colspan="7" class="empty-state">Carregando...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal-overlay" id="modal-conversao">
    <div class="modal-content">
        <div class="modal-header">Registrar Nova Conversao</div>
        <div class="form-group">
            <label class="form-label">Telefone do Cliente</label>
            <input type="text" class="form-input" id="conv-phone" placeholder="18572081139">
        </div>
        <div class="form-group">
            <label class="form-label">Valor ($)</label>
            <input type="number" class="form-input" id="conv-valor" placeholder="150.00" step="0.01">
        </div>
        <div class="form-group">
            <label class="form-label">Observacao</label>
            <input type="text" class="form-input" id="conv-obs" placeholder="Traducao de certidao">
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="fecharModal()">Cancelar</button>
            <button class="btn-confirm" onclick="registrarConversao()">Registrar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let periodo = 15;
    let chartConversoes = null;
    let chartAtendimentos = null;

    window.onload = function() {
        carregarDados();
    };

    function setPeriodo(dias) {
        periodo = dias;
        document.querySelectorAll('.periodo-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.periodo == dias) btn.classList.add('active');
        });
        carregarDados();
    }

    async function carregarDados() {
        await Promise.all([
            carregarStats(),
            carregarCharts(),
            carregarConversoes(),
            carregarLeads()
        ]);
    }

    async function carregarStats() {
        try {
            const response = await fetch('/admin/conversas/api/stats?periodo=' + periodo);
            const data = await response.json();

            document.getElementById('valor-total').textContent = '$' + (data.valor_total || 0).toLocaleString();
            document.getElementById('conversoes-total').textContent = (data.conversoes || 0) + ' conversoes';
            document.getElementById('taxa-conversao').textContent = (data.taxa_conversao || 0) + '%';
            document.getElementById('clientes-unicos').textContent = data.clientes_unicos || 0;
            document.getElementById('total-msgs').textContent = (data.total_conversas || 0) + ' mensagens';

            document.getElementById('stat-conversoes').textContent = data.conversoes || 0;
            document.getElementById('stat-clientes').textContent = data.clientes_unicos || 0;
            document.getElementById('stat-ia').textContent = data.atendimentos_ia || 0;
            document.getElementById('stat-humano').textContent = data.atendimentos_humano || 0;
            document.getElementById('stat-taxa').textContent = (data.taxa_conversao || 0) + '%';
        } catch (error) {
            console.error('Erro ao carregar stats:', error);
        }
    }

    async function carregarCharts() {
        try {
            const response = await fetch('/admin/conversas/api/chart-data?periodo=' + periodo);
            const data = await response.json();

            var labels = data.labels.map(function(d) {
                var date = new Date(d);
                return date.getDate() + '/' + (date.getMonth()+1);
            });

            var ctxConv = document.getElementById('chartConversoes').getContext('2d');
            if (chartConversoes) chartConversoes.destroy();
            chartConversoes = new Chart(ctxConv, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Conversoes',
                        data: data.conversoes,
                        backgroundColor: 'rgba(39, 174, 96, 0.8)',
                        borderColor: 'rgba(39, 174, 96, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            var ctxAtend = document.getElementById('chartAtendimentos').getContext('2d');
            if (chartAtendimentos) chartAtendimentos.destroy();
            chartAtendimentos = new Chart(ctxAtend, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'IA',
                        data: data.atendimentos_ia,
                        borderColor: 'rgba(155, 89, 182, 1)',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Humano',
                        data: data.atendimentos_humano,
                        borderColor: 'rgba(243, 156, 18, 1)',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        } catch (error) {
            console.error('Erro ao carregar charts:', error);
        }
    }

    async function carregarConversoes() {
        try {
            const response = await fetch('/admin/conversas/api/conversoes?periodo=' + periodo);
            const data = await response.json();

            const tbody = document.getElementById('conversoes-body');

            if (!data.conversoes || data.conversoes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Nenhuma conversao no periodo</td></tr>';
                return;
            }

            var html = '';
            data.conversoes.forEach(function(c) {
                var badgeClass = c.tipo_atendimento === 'IA' ? 'badge-ia' : 'badge-humano';
                html += '<tr>';
                html += '<td><strong>' + c.phone + '</strong></td>';
                html += '<td><span style="color: #27ae60; font-weight: bold;">$' + c.valor.toLocaleString() + '</span></td>';
                html += '<td>' + c.timestamp + '</td>';
                html += '<td>' + c.tempo_atendimento + '</td>';
                html += '<td><span class="badge ' + badgeClass + '">' + c.tipo_atendimento + '</span></td>';
                html += '<td><span class="badge badge-info">' + c.metodo + '</span></td>';
                html += '</tr>';
            });
            tbody.innerHTML = html;
        } catch (error) {
            console.error('Erro ao carregar conversoes:', error);
        }
    }

    async function carregarLeads() {
        try {
            const response = await fetch('/admin/conversas/api/leads-followup?periodo=' + periodo);
            const data = await response.json();

            document.getElementById('leads-followup').textContent = data.total || 0;

            const tbody = document.getElementById('leads-body');

            if (!data.leads || data.leads.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Nenhum lead pendente</td></tr>';
                return;
            }

            var html = '';
            data.leads.forEach(function(l) {
                var orcBadge = l.pediu_orcamento === 'Sim' ? 'badge-success' : 'badge-warning';
                var priClass = 'prioridade-' + l.prioridade.toLowerCase();
                html += '<tr>';
                html += '<td><strong>' + l.phone + '</strong><br><small style="color: #7f8c8d;">' + l.preview + '...</small></td>';
                html += '<td>' + l.ultima_msg + '</td>';
                html += '<td>' + l.total_msgs + '</td>';
                html += '<td>' + l.dias_sem_contato + ' dias</td>';
                html += '<td><span class="badge ' + orcBadge + '">' + l.pediu_orcamento + '</span></td>';
                html += '<td><span class="badge ' + priClass + '">' + l.prioridade + '</span></td>';
                html += '<td><button class="btn-action btn-whatsapp" onclick="abrirWhatsApp(\'' + l.phone + '\')">Contatar</button></td>';
                html += '</tr>';
            });
            tbody.innerHTML = html;
        } catch (error) {
            console.error('Erro ao carregar leads:', error);
        }
    }

    function abrirWhatsApp(phone) {
        window.open('https://wa.me/' + phone, '_blank');
    }

    function abrirModalConversao() {
        document.getElementById('modal-conversao').style.display = 'flex';
    }

    function fecharModal() {
        document.getElementById('modal-conversao').style.display = 'none';
    }

    async function registrarConversao() {
        var phone = document.getElementById('conv-phone').value;
        var valor = document.getElementById('conv-valor').value;
        var obs = document.getElementById('conv-obs').value;

        if (!phone || !valor) {
            alert('Preencha telefone e valor');
            return;
        }

        try {
            const response = await fetch('/admin/conversas/api/registrar-conversao', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone: phone, valor: valor, observacao: obs })
            });
            const data = await response.json();

            if (data.success) {
                alert('Conversao registrada com sucesso!');
                fecharModal();
                carregarDados();
            } else {
                alert('Erro: ' + data.error);
            }
        } catch (error) {
            alert('Erro ao registrar conversao');
        }
    }
</script>
{% endblock %}
