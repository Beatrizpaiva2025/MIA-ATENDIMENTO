{% extends "admin_base.html" %}

{% block title %}Pipeline de Vendas - Painel Administrativo{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üéØ Pipeline de Vendas (Funil)</h2>
        <div>
            <button class="btn btn-success" onclick="exportarPipeline()">
                <i class="bi bi-download"></i> Exportar
            </button>
            <button class="btn btn-primary" onclick="atualizarDados()">
                <i class="bi bi-arrow-clockwise"></i> Atualizar
            </button>
        </div>
    </div>

    <!-- M√©tricas Gerais -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-funnel"></i> Total no Funil</h5>
                    <p class="card-text display-4" id="totalFunil">-</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-currency-dollar"></i> Valor Total</h5>
                    <p class="card-text display-4" id="valorTotal">R$ -</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-percent"></i> Taxa Convers√£o</h5>
                    <p class="card-text display-4" id="taxaConversao">-%</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-clock-history"></i> Tempo M√©dio</h5>
                    <p class="card-text display-4" id="tempoMedio">- dias</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Visualiza√ß√£o do Funil -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Funil de Vendas</h6>
        </div>
        <div class="card-body">
            <div id="funnelContainer" class="mb-4">
                <!-- Funil visual ser√° renderizado aqui -->
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label for="filtroEtapa" class="form-label">Etapa:</label>
                    <select class="form-select" id="filtroEtapa" onchange="filtrarOportunidades()">
                        <option value="todas">Todas</option>
                        <option value="contato_inicial">Contato Inicial</option>
                        <option value="qualificacao">Qualifica√ß√£o</option>
                        <option value="proposta">Proposta Enviada</option>
                        <option value="negociacao">Negocia√ß√£o</option>
                        <option value="fechamento">Fechamento</option>
                        <option value="ganho">Ganho</option>
                        <option value="perdido">Perdido</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filtroValor" class="form-label">Faixa de Valor:</label>
                    <select class="form-select" id="filtroValor" onchange="filtrarOportunidades()">
                        <option value="todos">Todos</option>
                        <option value="ate1000">At√© R$ 1.000</option>
                        <option value="1000a5000">R$ 1.000 - R$ 5.000</option>
                        <option value="acima5000">Acima de R$ 5.000</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filtroPrioridade" class="form-label">Prioridade:</label>
                    <select class="form-select" id="filtroPrioridade" onchange="filtrarOportunidades()">
                        <option value="todas">Todas</option>
                        <option value="alta">Alta</option>
                        <option value="media">M√©dia</option>
                        <option value="baixa">Baixa</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="busca" class="form-label">Buscar:</label>
                    <input type="text" class="form-control" id="busca" placeholder="Cliente..." onkeyup="filtrarOportunidades()">
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Oportunidades -->
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Oportunidades</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Etapa</th>
                            <th>Valor</th>
                            <th>Prioridade</th>
                            <th>Probabilidade</th>
                            <th>Tempo no Funil</th>
                            <th>Pr√≥xima A√ß√£o</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="oportunidadesTableBody">
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes da Oportunidade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDetalhesBody">
                <!-- Conte√∫do carregado dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="salvarOportunidade()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script>
let oportunidadesData = [];
let oportunidadeAtual = null;

async function carregarDados() {
    try {
        const response = await fetch('/admin/api/pipeline');
        const data = await response.json();
        
        oportunidadesData = data.oportunidades || [];
        
        // Atualizar m√©tricas
        document.getElementById('totalFunil').textContent = data.total || 0;
        document.getElementById('valorTotal').textContent = 'R$ ' + (data.valor_total || 0).toLocaleString('pt-BR');
        document.getElementById('taxaConversao').textContent = (data.taxa_conversao || 0) + '%';
        document.getElementById('tempoMedio').textContent = (data.tempo_medio || 0) + ' dias';
        
        // Renderizar funil
        renderizarFunil(data.funil || {});
        
        // Atualizar tabela
        filtrarOportunidades();
        
    } catch (error) {
        console.error('Erro ao carregar dados:', error);
        document.getElementById('oportunidadesTableBody').innerHTML = 
            '<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados</td></tr>';
    }
}

function renderizarFunil(dadosFunil) {
    const etapas = [
        {nome: 'Contato Inicial', key: 'contato_inicial', cor: '#6c5ce7'},
        {nome: 'Qualifica√ß√£o', key: 'qualificacao', cor: '#a29bfe'},
        {nome: 'Proposta', key: 'proposta', cor: '#74b9ff'},
        {nome: 'Negocia√ß√£o', key: 'negociacao', cor: '#fdcb6e'},
        {nome: 'Fechamento', key: 'fechamento', cor: '#55efc4'},
        {nome: 'Ganho', key: 'ganho', cor: '#00b894'}
    ];
    
    const maxValor = Math.max(...etapas.map(e => dadosFunil[e.key]?.total || 0));
    
    let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
    
    etapas.forEach(etapa => {
        const dados = dadosFunil[etapa.key] || {total: 0, valor: 0};
        const largura = maxValor > 0 ? (dados.total / maxValor) * 100 : 0;
        
        html += `
            <div class="funil-etapa" style="position: relative;">
                <div style="background: ${etapa.cor}; width: ${largura}%; padding: 20px; border-radius: 8px; 
                            color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h5 style="margin: 0; font-weight: bold;">${etapa.nome}</h5>
                            <p style="margin: 5px 0 0 0; opacity: 0.9;">${dados.total} oportunidades</p>
                        </div>
                        <div style="text-align: right;">
                            <h4 style="margin: 0;">R$ ${dados.valor.toLocaleString('pt-BR')}</h4>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    document.getElementById('funnelContainer').innerHTML = html;
}

function filtrarOportunidades() {
    const filtroEtapa = document.getElementById('filtroEtapa').value;
    const filtroValor = document.getElementById('filtroValor').value;
    const filtroPrioridade = document.getElementById('filtroPrioridade').value;
    const busca = document.getElementById('busca').value.toLowerCase();
    
    let oportunidadesFiltradas = oportunidadesData.filter(op => {
        const passaEtapa = filtroEtapa === 'todas' || op.etapa === filtroEtapa;
        const passaPrioridade = filtroPrioridade === 'todas' || op.prioridade === filtroPrioridade;
        
        let passaValor = true;
        if (filtroValor === 'ate1000') passaValor = op.valor <= 1000;
        else if (filtroValor === '1000a5000') passaValor = op.valor > 1000 && op.valor <= 5000;
        else if (filtroValor === 'acima5000') passaValor = op.valor > 5000;
        
        const passaBusca = busca === '' || op.cliente.toLowerCase().includes(busca);
        
        return passaEtapa && passaValor && passaPrioridade && passaBusca;
    });
    
    atualizarTabela(oportunidadesFiltradas);
}

function atualizarTabela(oportunidades) {
    const tbody = document.getElementById('oportunidadesTableBody');
    
    if (oportunidades.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhuma oportunidade encontrada</td></tr>';
        return;
    }
    
    tbody.innerHTML = oportunidades.map(op => {
        const diasNoFunil = Math.floor((new Date() - new Date(op.data_entrada)) / (1000 * 60 * 60 * 24));
        
        return `
            <tr>
                <td><strong>${op.cliente}</strong><br><small>${op.telefone}</small></td>
                <td>${getEtapaBadge(op.etapa)}</td>
                <td><strong>R$ ${op.valor.toLocaleString('pt-BR')}</strong></td>
                <td>${getPrioridadeBadge(op.prioridade)}</td>
                <td>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar ${getProgressBarClass(op.probabilidade)}" 
                             style="width: ${op.probabilidade}%">${op.probabilidade}%</div>
                    </div>
                </td>
                <td>${diasNoFunil} dias</td>
                <td><small>${op.proxima_acao || '-'}</small></td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="verDetalhes('${op._id}')">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-success" onclick="moverEtapa('${op._id}')">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function getEtapaBadge(etapa) {
    const badges = {
        'contato_inicial': '<span class="badge bg-secondary">Contato Inicial</span>',
        'qualificacao': '<span class="badge bg-info">Qualifica√ß√£o</span>',
        'proposta': '<span class="badge bg-primary">Proposta</span>',
        'negociacao': '<span class="badge bg-warning">Negocia√ß√£o</span>',
        'fechamento': '<span class="badge bg-success">Fechamento</span>',
        'ganho': '<span class="badge bg-success">Ganho</span>',
        'perdido': '<span class="badge bg-danger">Perdido</span>'
    };
    return badges[etapa] || '<span class="badge bg-secondary">-</span>';
}

function getPrioridadeBadge(prioridade) {
    const badges = {
        'alta': '<span class="badge bg-danger">Alta</span>',
        'media': '<span class="badge bg-warning">M√©dia</span>',
        'baixa': '<span class="badge bg-secondary">Baixa</span>'
    };
    return badges[prioridade] || '-';
}

function getProgressBarClass(probabilidade) {
    if (probabilidade >= 75) return 'bg-success';
    if (probabilidade >= 50) return 'bg-info';
    if (probabilidade >= 25) return 'bg-warning';
    return 'bg-danger';
}

async function verDetalhes(opId) {
    oportunidadeAtual = oportunidadesData.find(o => o._id === opId);
    if (!oportunidadeAtual) return;
    
    const modalBody = document.getElementById('modalDetalhesBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Informa√ß√µes do Cliente:</h6>
                <p><strong>Nome:</strong> ${oportunidadeAtual.cliente}</p>
                <p><strong>Telefone:</strong> ${oportunidadeAtual.telefone}</p>
                <p><strong>Email:</strong> ${oportunidadeAtual.email || '-'}</p>
            </div>
            <div class="col-md-6">
                <h6>Detalhes da Oportunidade:</h6>
                <div class="mb-3">
                    <label class="form-label">Etapa:</label>
                    <select class="form-select" id="editEtapa">
                        <option value="contato_inicial">Contato Inicial</option>
                        <option value="qualificacao">Qualifica√ß√£o</option>
                        <option value="proposta">Proposta</option>
                        <option value="negociacao">Negocia√ß√£o</option>
                        <option value="fechamento">Fechamento</option>
                        <option value="ganho">Ganho</option>
                        <option value="perdido">Perdido</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Valor (R$):</label>
                    <input type="number" class="form-control" id="editValor" value="${oportunidadeAtual.valor}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Probabilidade (%):</label>
                    <input type="number" class="form-control" id="editProbabilidade" value="${oportunidadeAtual.probabilidade}" min="0" max="100">
                </div>
                <div class="mb-3">
                    <label class="form-label">Prioridade:</label>
                    <select class="form-select" id="editPrioridade">
                        <option value="alta">Alta</option>
                        <option value="media">M√©dia</option>
                        <option value="baixa">Baixa</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <label class="form-label">Pr√≥xima A√ß√£o:</label>
                <input type="text" class="form-control" id="editProximaAcao" value="${oportunidadeAtual.proxima_acao || ''}">
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <label class="form-label">Observa√ß√µes:</label>
                <textarea class="form-control" id="editObservacoes" rows="3">${oportunidadeAtual.observacoes || ''}</textarea>
            </div>
        </div>
    `;
    
    // Definir valores atuais
    document.getElementById('editEtapa').value = oportunidadeAtual.etapa;
    document.getElementById('editPrioridade').value = oportunidadeAtual.prioridade;
    
    const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
    modal.show();
}

async function salvarOportunidade() {
    if (!oportunidadeAtual) return;
    
    try {
        const dadosAtualizados = {
            etapa: document.getElementById('editEtapa').value,
            valor: parseFloat(document.getElementById('editValor').value),
            probabilidade: parseInt(document.getElementById('editProbabilidade').value),
            prioridade: document.getElementById('editPrioridade').value,
            proxima_acao: document.getElementById('editProximaAcao').value,
            observacoes: document.getElementById('editObservacoes').value
        };
        
        const response = await fetch(`/admin/api/pipeline/${oportunidadeAtual._id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dadosAtualizados)
        });
        
        if (response.ok) {
            alert('Oportunidade atualizada!');
            bootstrap.Modal.getInstance(document.getElementById('modalDetalhes')).hide();
            carregarDados();
        }
    } catch (error) {
        console.error('Erro ao salvar:', error);
    }
}

function moverEtapa(opId) {
    const op = oportunidadesData.find(o => o._id === opId);
    if (!op) return;
    
    const proximasEtapas = {
        'contato_inicial': 'qualificacao',
        'qualificacao': 'proposta',
        'proposta': 'negociacao',
        'negociacao': 'fechamento',
        'fechamento': 'ganho'
    };
    
    if (proximasEtapas[op.etapa]) {
        oportunidadeAtual = op;
        fetch(`/admin/api/pipeline/${op._id}/mover`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({nova_etapa: proximasEtapas[op.etapa]})
        }).then(() => carregarDados());
    }
}

function exportarPipeline() {
    window.location.href = '/admin/api/pipeline/export';
}

function atualizarDados() {
    carregarDados();
}

// Carregar ao iniciar
carregarDados();

// Atualizar a cada minuto
setInterval(carregarDados, 60000);
</script>

<style>
.funil-etapa:hover {
    transform: translateX(5px);
}
</style>
{% endblock %}
