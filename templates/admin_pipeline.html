{% extends "admin_base.html" %}

{% block title %}Pipeline de Vendas - Painel Administrativo{% endblock %}

{% block page_title %}üéØ Pipeline de Vendas{% endblock %}
{% block page_subtitle %}Acompanhe suas oportunidades de neg√≥cio em tempo real.{% endblock %}

{% block header_actions %}
    <button class="btn btn-outline" onclick="exportarPipeline()">
        <i class="fas fa-download"></i> Exportar
    </button>
    <button class="btn btn-primary" onclick="atualizarDados()">
        <i class="fas fa-sync-alt"></i> Atualizar
    </button>
{% endblock %}

{% block content %}

<!-- 1. M√©tricas Gerais -->
<div class="stats-grid">
    <div class="stat-card">
        <h3><i class="fas fa-funnel-dollar"></i> Total no Funil</h3>
        <div class="stat-value" id="totalFunil">-</div>
        <div class="stat-icon"><i class="fas fa-users"></i></div>
    </div>
    <div class="stat-card">
        <h3><i class="fas fa-wallet"></i> Valor Total</h3>
        <div class="stat-value" id="valorTotal">R$ -</div>
        <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
    </div>
    <div class="stat-card">
        <h3><i class="fas fa-chart-line"></i> Taxa de Convers√£o</h3>
        <div class="stat-value" id="taxaConversao">-%</div>
        <div class="stat-icon"><i class="fas fa-percentage"></i></div>
    </div>
    <div class="stat-card">
        <h3><i class="fas fa-history"></i> Tempo M√©dio</h3>
        <div class="stat-value" id="tempoMedio">- dias</div>
        <div class="stat-icon"><i class="fas fa-clock"></i></div>
    </div>
</div>

<!-- 2. Visualiza√ß√£o do Funil (Kanban) -->
<div class="card">
    <div class="card-header">
        <h2>Visualiza√ß√£o do Funil</h2>
        <p>Arraste e solte as oportunidades para mov√™-las entre as etapas.</p>
    </div>
    <div class="card-body">
        <div class="kanban-board" id="kanbanBoard">
            <!-- Colunas do Kanban ser√£o geradas via JS -->
        </div>
    </div>
</div>

<!-- 3. Lista de Oportunidades (Tabela) -->
<div class="card mt-4">
    <div class="card-header">
        <h2>Todas as Oportunidades</h2>
        <p>Visualize e filtre todos os leads em um √∫nico lugar.</p>
    </div>
    <div class="card-body">
        <!-- Filtros -->
        <div class="row mb-4">
            <div class="col-md-3 form-group">
                <label for="filtroEtapa">Etapa</label>
                <select class="form-control" id="filtroEtapa" onchange="filtrarOportunidades()"></select>
            </div>
            <div class="col-md-3 form-group">
                <label for="filtroPrioridade">Prioridade</label>
                <select class="form-control" id="filtroPrioridade" onchange="filtrarOportunidades()">
                    <option value="todas">Todas</option>
                    <option value="alta">Alta</option>
                    <option value="media">M√©dia</option>
                    <option value="baixa">Baixa</option>
                </select>
            </div>
            <div class="col-md-6 form-group">
                <label for="busca">Buscar por Cliente</label>
                <input type="text" class="form-control" id="busca" placeholder="Digite o nome do cliente..." onkeyup="filtrarOportunidades()">
            </div>
        </div>
        
        <!-- Tabela -->
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Valor</th>
                        <th>Etapa</th>
                        <th>Prioridade</th>
                        <th>Probabilidade</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="oportunidadesTableBody">
                    <tr><td colspan="6" class="text-center p-4">Carregando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal de Detalhes (ser√° preenchido via JS) -->
<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes da Oportunidade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDetalhesBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="salvarOportunidade()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .kanban-board { display: flex; gap: 20px; overflow-x: auto; padding: 10px; min-height: 400px; background-color: var(--gray-50); border-radius: 8px; }
    .kanban-column { flex: 0 0 300px; background-color: var(--gray-100); border-radius: 8px; padding: 15px; }
    .kanban-column-header { padding-bottom: 15px; margin-bottom: 15px; border-bottom: 2px solid var(--gray-200); }
    .kanban-column-header h3 { font-size: 1rem; font-weight: 600; color: var(--legacy-navy); }
    .kanban-column-header .etapa-total { font-size: 0.8rem; color: var(--gray-500); }
    .kanban-cards { min-height: 200px; display: flex; flex-direction: column; gap: 10px; }
    .kanban-card { background: var(--white); border-radius: 8px; padding: 15px; box-shadow: var(--shadow-sm); border-left: 4px solid var(--legacy-blue); cursor: grab; }
    .kanban-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
    .kanban-card h4 { font-size: 0.95rem; font-weight: 600; color: var(--gray-700); }
    .kanban-card .card-valor { font-size: 1.1rem; font-weight: 700; color: var(--success); }
    .kanban-card .card-info { font-size: 0.8rem; color: var(--gray-500); }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// Adapte seu JS para preencher este novo layout
document.addEventListener('DOMContentLoaded', function( ) {
    console.log("Pipeline inicializado com novo layout.");
    // Aqui voc√™ deve chamar sua fun√ß√£o original `carregarDados()` para preencher a p√°gina.
});
</script>
{% endblock %}
