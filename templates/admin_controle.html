{% extends "admin_base.html" %}

{% block title %}Control - MIA Admin{% endblock %}

{% block extra_style %}
<style>
    /* ============================================
       LAYOUT PROFISSIONAL - FONTES MENORES
       ============================================ */

    .page-header h1 {
        font-size: 1.4em;
        color: #1e3a5f;
        margin-bottom: 5px;
    }

    .page-header p {
        font-size: 0.85em;
        color: #666;
    }

    .control-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .control-card {
        background: white;
        border-radius: 8px;
        padding: 18px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-left: 3px solid #5dade2;
    }

    .control-card.warning {
        border-left-color: #e74c3c;
    }

    .control-card.config {
        border-left-color: #ff9800;
    }

    .control-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 12px;
        border-bottom: 1px solid #f0f0f0;
    }

    .control-icon {
        font-size: 1.3em;
        margin-right: 10px;
    }

    .control-title {
        font-size: 0.95em;
        color: #1e3a5f;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .toggle-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 10px;
    }

    .toggle-label {
        font-weight: 500;
        color: #444;
        font-size: 0.85em;
    }

    .toggle-switch {
        position: relative;
        width: 44px;
        height: 22px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .3s;
        border-radius: 22px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .3s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: #27ae60;
    }

    input:checked + .slider:before {
        transform: translateX(22px);
    }

    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.75em;
        text-transform: uppercase;
    }

    .status-online {
        background: #d4edda;
        color: #155724;
    }

    .status-offline {
        background: #f8d7da;
        color: #721c24;
    }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .stat-box {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #e9ecef;
    }

    .stat-box.primary { border-left: 3px solid #3498db; }
    .stat-box.warning { border-left: 3px solid #f39c12; }
    .stat-box.danger { border-left: 3px solid #e74c3c; }
    .stat-box.success { border-left: 3px solid #27ae60; }

    .stat-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #1e3a5f;
    }

    .stat-label {
        font-size: 0.7em;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-action {
        background: #5dade2;
        color: white;
        padding: 8px 14px;
        border: none;
        border-radius: 5px;
        font-size: 0.8em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        width: 100%;
        margin-top: 8px;
    }

    .btn-action:hover {
        background: #4a9dd1;
    }

    .btn-action.danger {
        background: #e74c3c;
    }

    .btn-action.danger:hover {
        background: #c0392b;
    }

    .btn-action.success {
        background: #27ae60;
    }

    .btn-action.success:hover {
        background: #229954;
    }

    .btn-action.secondary {
        background: #6c757d;
    }

    .btn-action.secondary:hover {
        background: #5a6268;
    }

    .info-text {
        color: #666;
        font-size: 0.75em;
        line-height: 1.5;
        margin-top: 8px;
    }

    .config-section {
        margin-top: 12px;
    }

    .config-section h3 {
        font-size: 0.8em;
        color: #444;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .config-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        font-size: 0.85em;
        transition: border-color 0.2s;
        margin-bottom: 6px;
    }

    .config-input:focus {
        outline: none;
        border-color: #5dade2;
    }

    .help-box {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 12px;
        margin-top: 12px;
        border: 1px solid #e9ecef;
    }

    .help-box h4 {
        color: #1e3a5f;
        margin-bottom: 8px;
        font-size: 0.8em;
        font-weight: 600;
    }

    .help-box p {
        color: #666;
        font-size: 0.75em;
        margin-bottom: 4px;
        line-height: 1.4;
    }

    .help-box code {
        background: #e9ecef;
        padding: 1px 5px;
        border-radius: 3px;
        font-weight: 600;
        font-size: 0.9em;
    }

    .client-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 8px;
        border-left: 3px solid #5dade2;
    }

    .client-card.human-mode {
        border-left-color: #e74c3c;
        background: #fef5f5;
    }

    .client-info {
        flex: 1;
    }

    .client-phone {
        font-weight: 600;
        color: #1e3a5f;
        font-size: 0.85em;
    }

    .client-details {
        font-size: 0.7em;
        color: #666;
        margin-top: 2px;
    }

    .client-badge {
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 0.65em;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-ia {
        background: #d4edda;
        color: #155724;
    }

    .badge-human {
        background: #f8d7da;
        color: #721c24;
    }

    .section-divider {
        margin: 20px 0;
        border-top: 1px solid #e9ecef;
    }

    .logs-container {
        background: #1e3a5f;
        padding: 12px;
        border-radius: 6px;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.7em;
        max-height: 200px;
        overflow-y: auto;
        color: #b8c5d0;
    }

    .logs-container div {
        margin-bottom: 3px;
        line-height: 1.4;
    }

    .btn-sm {
        padding: 5px 10px;
        font-size: 0.7em;
        border-radius: 4px;
    }

    .empty-state {
        text-align: center;
        padding: 20px;
        color: #27ae60;
        background: #f0fff4;
        border-radius: 6px;
        font-size: 0.85em;
    }

    .empty-state.neutral {
        color: #666;
        background: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Bot Control</h1>
    <p>Manage MIA's status and settings</p>
</div>

<div class="control-grid">
    <!-- BOT STATUS -->
    <div class="control-card">
        <div class="control-header">
            <span class="control-icon">ü§ñ</span>
            <div>
                <div class="control-title">Bot Status</div>
                <span class="status-badge status-online" id="status-badge">Online</span>
            </div>
        </div>

        <div class="toggle-container">
            <span class="toggle-label">AI Active</span>
            <label class="toggle-switch">
                <input type="checkbox" id="toggle-ia" checked onchange="toggleIA()">
                <span class="slider"></span>
            </label>
        </div>

        <div class="toggle-container">
            <span class="toggle-label">Maintenance Mode</span>
            <label class="toggle-switch">
                <input type="checkbox" id="toggle-manutencao" onchange="toggleManutencao()">
                <span class="slider"></span>
            </label>
        </div>

        <p class="info-text">
            <strong>AI Active:</strong> Bot responds automatically<br>
            <strong>Maintenance:</strong> Bot sends maintenance message
        </p>
    </div>

    <!-- ESTAT√çSTICAS -->
    <div class="control-card">
        <div class="control-header">
            <span class="control-icon">üìä</span>
            <div class="control-title">Today's Statistics</div>
        </div>

        <div class="stats-row">
            <div class="stat-box primary">
                <div class="stat-value" id="stat-mensagens">0</div>
                <div class="stat-label">Messages</div>
            </div>
            <div class="stat-box warning">
                <div class="stat-value" id="stat-conversas">0</div>
                <div class="stat-label">Conversations</div>
            </div>
            <div class="stat-box danger">
                <div class="stat-value" id="stat-transferencias">0</div>
                <div class="stat-label">Transfers</div>
            </div>
            <div class="stat-box success">
                <div class="stat-value" id="stat-conversoes">0</div>
                <div class="stat-label">Conversions</div>
            </div>
        </div>

        <button class="btn-action secondary" onclick="atualizarStats()">Update Stats</button>
    </div>

    <!-- Quick Actions -->
    <div class="control-card">
        <div class="control-header">
            <span class="control-icon">‚ö°</span>
            <div class="control-title">Quick Actions</div>
        </div>

        <button class="btn-action danger" onclick="resetarTravados()">Unlock Stuck Clients</button>
        <button class="btn-action secondary" onclick="limparCache()">Clear Cache</button>
        <button class="btn-action" onclick="reiniciarBot()">Restart Bot</button>
        <button class="btn-action success" onclick="exportarDados()">Export Data</button>
    </div>
</div>

<!-- CONFIGURA√á√ÉO DO OPERADOR -->
<div class="control-card config" style="margin-top: 15px;">
    <div class="control-header">
        <span class="control-icon">üì±</span>
        <div class="control-title">Operator Configuration</div>
    </div>

    <div class="config-section">
        <h3>Alerts Number (receives transfer summaries)</h3>
        <input type="text" id="alerts-number" class="config-input" placeholder="18572081139" value="18572081139">
    </div>

    <div class="config-section">
        <h3>Commands Number (sends * and + commands)</h3>
        <input type="text" id="operator-number" class="config-input" placeholder="18573167770" value="18573167770">
    </div>

    <button class="btn-action success" onclick="saveOperator()" style="margin-top: 12px;">
        Save Both Numbers
    </button>

    <div class="help-box">
        <h4>How It Works</h4>
        <p><strong>1.</strong> Client asks to speak with a human</p>
        <p><strong>2.</strong> Summary is sent to Alerts Number</p>
        <p><strong>3.</strong> Open client's chat and send:</p>
        <p style="margin-left: 12px;"><code>*</code> Pause AI &nbsp;|&nbsp; <code>+</code> Resume AI</p>
    </div>
</div>

<!-- CLIENTES EM MODO HUMANO -->
<div class="control-card warning" style="margin-top: 15px;">
    <div class="control-header">
        <span class="control-icon">üî¥</span>
        <div class="control-title">Clients with Paused AI</div>
    </div>

    <div id="clientes-humano-container" style="max-height: 200px; overflow-y: auto;">
        <div class="empty-state neutral">Loading...</div>
    </div>

    <div style="display: flex; gap: 8px; margin-top: 12px;">
        <button class="btn-action secondary" onclick="carregarClientesHumano()" style="flex: 1;">Update</button>
        <button class="btn-action success" onclick="retomarTodosIA()" style="flex: 1;">Resume All</button>
    </div>
</div>

<!-- CLIENTES ATIVOS -->
<div class="control-card" style="margin-top: 15px;">
    <div class="control-header">
        <span class="control-icon">üë•</span>
        <div class="control-title">Active Clients Today</div>
    </div>

    <div id="clientes-container" style="max-height: 200px; overflow-y: auto;">
        <div class="empty-state neutral">Loading clients...</div>
    </div>

    <button class="btn-action secondary" onclick="carregarClientes()" style="margin-top: 12px;">Update Clients</button>
</div>

<!-- LOGS RECENTES -->
<div class="control-card" style="margin-top: 15px;">
    <div class="control-header">
        <span class="control-icon">üìù</span>
        <div class="control-title">Recent Logs</div>
    </div>

    <div id="logs-container" class="logs-container">
        <div>Loading logs...</div>
    </div>

    <button class="btn-action secondary" onclick="carregarLogs()" style="margin-top: 12px;">Update Logs</button>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Carregar status ao abrir p√°gina
    window.onload = function() {
        carregarStatus();
        carregarStats();
        carregarLogs();
        carregarConfig();
        carregarClientes();
        carregarClientesHumano();

        // Auto-refresh
        setInterval(carregarStatus, 5000);
        setInterval(carregarClientes, 10000);
        setInterval(carregarClientesHumano, 15000);
    };

    async function carregarStatus() {
        try {
            const response = await fetch('/admin/controle/api/status');
            const data = await response.json();

            document.getElementById('toggle-ia').checked = data.ia_ativa;
            document.getElementById('toggle-manutencao').checked = data.modo_manutencao;

            const badge = document.getElementById('status-badge');
            if (data.ia_ativa) {
                badge.className = 'status-badge status-online';
                badge.textContent = 'Online';
            } else {
                badge.className = 'status-badge status-offline';
                badge.textContent = 'Offline';
            }
        } catch (error) {
            console.error('Error loading status:', error);
        }
    }

    async function toggleIA() {
        const ativo = document.getElementById('toggle-ia').checked;
        try {
            await fetch('/admin/controle/api/toggle-ia', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ativo })
            });
            carregarStatus();
        } catch (error) {
            alert('Error changing AI status');
        }
    }

    async function toggleManutencao() {
        const ativo = document.getElementById('toggle-manutencao').checked;
        try {
            await fetch('/admin/controle/api/toggle-manutencao', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ativo })
            });
        } catch (error) {
            alert('Error changing maintenance mode');
        }
    }

    async function carregarStats() {
        try {
            const response = await fetch('/admin/controle/api/stats');
            const data = await response.json();

            document.getElementById('stat-mensagens').textContent = data.mensagens || 0;
            document.getElementById('stat-conversas').textContent = data.conversas || 0;
            document.getElementById('stat-transferencias').textContent = data.transferencias || 0;
            document.getElementById('stat-conversoes').textContent = data.conversoes || 0;
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    function atualizarStats() {
        carregarStats();
    }

    async function carregarClientes() {
        try {
            const response = await fetch('/admin/controle/api/clientes-ativos');
            const data = await response.json();

            const container = document.getElementById('clientes-container');
            if (data.clientes && data.clientes.length > 0) {
                container.innerHTML = data.clientes.map(cliente => {
                    const isHuman = cliente.modo === 'human';
                    const badgeClass = isHuman ? 'badge-human' : 'badge-ia';
                    const badgeText = isHuman ? 'Human' : 'AI';
                    const cardClass = isHuman ? 'client-card human-mode' : 'client-card';

                    return `
                        <div class="${cardClass}">
                            <div class="client-info">
                                <div class="client-phone">${cliente.phone}</div>
                                <div class="client-details">
                                    Last: ${cliente.ultima_msg} | ${cliente.total_msgs} msgs
                                </div>
                            </div>
                            <span class="client-badge ${badgeClass}">${badgeText}</span>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div class="empty-state neutral">No active clients today</div>';
            }
        } catch (error) {
            document.getElementById('clientes-container').innerHTML =
                '<div style="color: #e74c3c; font-size: 0.85em;">Error loading clients</div>';
        }
    }

    async function carregarLogs() {
        try {
            const response = await fetch('/admin/controle/api/logs');
            const data = await response.json();

            const container = document.getElementById('logs-container');
            if (data.logs && data.logs.length > 0) {
                container.innerHTML = data.logs.map(log =>
                    `<div>${log}</div>`
                ).join('');
            } else {
                container.innerHTML = '<div style="color: #666;">No logs available</div>';
            }
        } catch (error) {
            document.getElementById('logs-container').innerHTML =
                '<div style="color: #e74c3c;">Error loading logs</div>';
        }
    }

    function limparCache() {
        if (confirm('Clear bot cache?')) {
            alert('Cache cleared!');
        }
    }

    function reiniciarBot() {
        if (confirm('Restart bot?')) {
            alert('Bot restarting...');
        }
    }

    function exportarDados() {
        alert('Export in development');
    }

    async function resetarTravados() {
        if (!confirm('Unlock all stuck clients?')) return;

        try {
            const response = await fetch('/admin/reset-all-human');
            const data = await response.json();

            if (data.status === 'success') {
                if (data.phones_resetados && data.phones_resetados.length > 0) {
                    alert(`${data.phones_resetados.length} client(s) unlocked!`);
                } else {
                    alert('No stuck clients found.');
                }
                carregarClientes();
            } else {
                alert('Error: ' + (data.message || 'Unknown'));
            }
        } catch (error) {
            alert('Connection error');
        }
    }

    async function carregarConfig() {
        try {
            const response = await fetch('/admin/controle/api/config');
            const data = await response.json();

            if (data.config) {
                if (data.config.operator_number) {
                    document.getElementById('operator-number').value = data.config.operator_number;
                }
                if (data.config.alerts_number) {
                    document.getElementById('alerts-number').value = data.config.alerts_number;
                }
            }
        } catch (error) {
            console.error('Error loading config:', error);
        }
    }

    async function saveOperator() {
        const operatorNumber = document.getElementById('operator-number').value;
        const alertsNumber = document.getElementById('alerts-number').value;

        if (!operatorNumber && !alertsNumber) {
            alert('Enter at least one number');
            return;
        }

        try {
            const response = await fetch('/admin/controle/api/config/operator', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    operator_number: operatorNumber,
                    alerts_number: alertsNumber
                })
            });
            const data = await response.json();

            if (data.success) {
                alert('Numbers saved!');
            } else {
                alert('Error: ' + (data.error || 'Unknown'));
            }
        } catch (error) {
            alert('Connection error');
        }
    }

    async function carregarClientesHumano() {
        try {
            const response = await fetch('/admin/api/clientes/modo-humano');
            const data = await response.json();

            const container = document.getElementById('clientes-humano-container');

            if (data.clientes && data.clientes.length > 0) {
                container.innerHTML = data.clientes.map(cliente => {
                    return `
                        <div class="client-card human-mode">
                            <div class="client-info">
                                <div class="client-phone">${cliente.phone}</div>
                                <div class="client-details">
                                    ${cliente.nome || 'Unknown'} | ${cliente.motivo || 'N/A'}
                                </div>
                            </div>
                            <button onclick="retomarIACliente('${cliente.phone}')"
                                    class="btn-action success btn-sm">
                                Resume
                            </button>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div class="empty-state">No clients with paused AI</div>';
            }
        } catch (error) {
            document.getElementById('clientes-humano-container').innerHTML =
                '<div style="color: #e74c3c; font-size: 0.85em;">Error loading</div>';
        }
    }

    async function retomarIACliente(phone) {
        if (!confirm(`Resume AI for ${phone}?`)) return;

        try {
            const response = await fetch(`/admin/api/cliente/${phone}/retomar`, {
                method: 'POST'
            });
            const data = await response.json();

            if (data.success) {
                alert(`AI resumed for ${phone}`);
                carregarClientesHumano();
                carregarClientes();
            } else {
                alert('Error: ' + (data.detail || 'Unknown'));
            }
        } catch (error) {
            alert('Connection error');
        }
    }

    async function retomarTodosIA() {
        if (!confirm('Resume AI for ALL clients?')) return;

        try {
            const response = await fetch('/admin/api/clientes/modo-humano');
            const data = await response.json();

            if (!data.clientes || data.clientes.length === 0) {
                alert('No clients with paused AI');
                return;
            }

            let sucessos = 0;
            let erros = 0;

            for (const cliente of data.clientes) {
                try {
                    const res = await fetch(`/admin/api/cliente/${cliente.phone}/retomar`, {
                        method: 'POST'
                    });
                    const result = await res.json();
                    if (result.success) sucessos++;
                    else erros++;
                } catch (e) {
                    erros++;
                }
            }

            alert(`Done! Resumed: ${sucessos} | Errors: ${erros}`);
            carregarClientesHumano();
            carregarClientes();

        } catch (error) {
            alert('Connection error');
        }
    }
</script>
{% endblock %}
