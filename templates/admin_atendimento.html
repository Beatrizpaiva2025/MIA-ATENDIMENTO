{% extends "admin_base.html" %}

{% block title %}Atendimento Humano - MIA Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ðŸ‘¤ Atendimento Humano</h1>
    <p>Gerencie conversas que precisam de atendimento manual</p>
</div>

<div style="background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; text-align: center;">
    <h2 style="font-size: 3em; margin: 0;">{{ conversas|length }}</h2>
    <p style="font-size: 1.2em; margin: 10px 0 0 0;">Conversas Aguardando Atendimento</p>
</div>

<div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
    <h3 style="color: #1e3a5f; margin-bottom: 20px;">ðŸ“‹ Conversas em Atendimento Humano</h3>
    
    {% if conversas %}
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #1e3a5f; color: white;">
                    <th style="padding: 15px; text-align: left; border-radius: 8px 0 0 0;">Telefone</th>
                    <th style="padding: 15px; text-align: left;">Ãšltima Mensagem</th>
                    <th style="padding: 15px; text-align: left;">Transferido em</th>
                    <th style="padding: 15px; text-align: center; border-radius: 0 8px 0 0;">AÃ§Ãµes</th>
                </tr>
            </thead>
            <tbody>
                {% for conversa in conversas %}
                <tr style="border-bottom: 1px solid #ddd; background: {% if loop.index % 2 == 0 %}#fff{% else %}#f8f9fa{% endif %};">
                    <td style="padding: 15px; font-weight: bold; color: #1e3a5f;">{{ conversa._id }}</td>
                    <td style="padding: 15px; color: #666;">{{ conversa.last_message[:50] }}...</td>
                    <td style="padding: 15px; color: #666;">
                        {% if conversa.transferred_at %}
                            {{ conversa.transferred_at.strftime('%d/%m %H:%M') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <a href="/admin/atendimento/{{ conversa._id }}" 
                           style="background: #5dade2; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; margin-right: 8px; display: inline-block;">
                            ðŸ’¬ Atender
                        </a>
                        <button onclick="devolverParaIA('{{ conversa._id }}')"
                                style="background: #ff9800; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer;">
                            ðŸ¤– Devolver para IA
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div style="text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 4em; margin-bottom: 20px;">âœ…</div>
            <p style="font-size: 1.2em;">Nenhuma conversa aguardando atendimento no momento.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    async function devolverParaIA(phone) {
        if (!confirm(`Devolver conversa de ${phone} para IA?`)) return;
        
        try {
            const response = await fetch(`/admin/reset-mode/${phone}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                alert('âœ… Conversa devolvida para IA!');
                location.reload();
            } else {
                alert('âŒ Erro: ' + data.message);
            }
        } catch (error) {
            alert('âŒ Erro ao devolver: ' + error);
        }
    }

    // Auto-refresh a cada 10 segundos
    setTimeout(() => location.reload(), 10000);
</script>
{% endblock %}
