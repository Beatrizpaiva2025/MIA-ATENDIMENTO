{% extends "admin_base.html" %}

{% block title %}Support - MIA Admin{% endblock %}

{% block extra_style %}
<style>
    .atendimento-header {
        background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }

    .atendimento-header h1 {
        margin: 0 0 10px 0;
        font-size: 2em;
    }

    .atendimento-header p {
        margin: 0;
        opacity: 0.9;
    }

    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
    }

    .stat-number {
        font-size: 2.5em;
        font-weight: 700;
        color: #1e3a5f;
        margin: 10px 0;
    }

    .stat-label {
        color: #666;
        font-size: 0.95em;
    }

    .conversas-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .conversas-empty {
        padding: 60px 20px;
        text-align: center;
        color: #999;
    }

    .conversas-empty-icon {
        font-size: 4em;
        margin-bottom: 20px;
    }

    .conversas-empty h3 {
        margin: 0 0 10px 0;
        color: #666;
    }

    .conversas-empty p {
        margin: 0 0 20px 0;
        color: #999;
    }

    .instrucao-box {
        background: #f0f7ff;
        border: 2px solid #2196f3;
        border-radius: 8px;
        padding: 20px;
        margin: 20px auto;
        max-width: 500px;
        text-align: left;
    }

    .instrucao-box h4 {
        margin: 0 0 10px 0;
        color: #1e3a5f;
    }

    .instrucao-box ol {
        margin: 10px 0;
        padding-left: 20px;
    }

    .instrucao-box li {
        margin: 8px 0;
        color: #555;
    }

    .conversa-item {
        border-bottom: 1px solid #e0e0e0;
        padding: 20px;
        transition: all 0.3s;
        cursor: pointer;
    }

    .conversa-item:hover {
        background: #f8f9fa;
    }

    .conversa-item:last-child {
        border-bottom: none;
    }

    .conversa-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .conversa-phone {
        font-size: 1.2em;
        font-weight: 600;
        color: #1e3a5f;
    }

    .conversa-badge {
        background: #ff9800;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 600;
    }

    .conversa-info {
        display: flex;
        gap: 20px;
        margin-bottom: 12px;
        font-size: 0.9em;
        color: #666;
    }

    .conversa-message {
        color: #444;
        font-size: 0.95em;
        margin-bottom: 12px;
    }

    .conversa-actions {
        display: flex;
        gap: 10px;
    }

    .btn-conversa {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9em;
    }

    .btn-visualizar {
        background: #2196f3;
        color: white;
    }

    .btn-visualizar:hover {
        background: #1976d2;
    }

    .btn-devolver {
        background: #ff9800;
        color: white;
    }

    .btn-devolver:hover {
        background: #e68900;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #999;
    }
</style>
{% endblock %}

{% block content %}
<div class="atendimento-header">
    <h1>üë• Support</h1>
    <p>Gerencie conversas em atendimento humano</p>
</div>

<div class="stats-container">
    <div class="stat-card">
        <div class="stat-label">üìä Total de Conversas</div>
        <div class="stat-number">{{ total }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">‚è≥ Aguardando Resposta</div>
        <div class="stat-number">{{ total }}</div>
    </div>
</div>

<div class="conversas-container">
    {% if conversas and conversas|length > 0 %}
        {% for conversa in conversas %}
        <div class="conversa-item">
            <div class="conversa-header">
                <div class="conversa-phone">üì± {{ conversa._id }}</div>
                <span class="conversa-badge">üî¥ Atendimento Humano</span>
            </div>
            
            <div class="conversa-info">
                <span>üí¨ {{ conversa.message_count }} mensagens</span>
                {% if conversa.transferred_at %}
                <span>üïê Transferido: {{ conversa.transferred_at.strftime('%d/%m %H:%M') if conversa.transferred_at else 'N/A' }}</span>
                {% endif %}
            </div>
            
            {% if conversa.transfer_reason %}
            <div class="conversa-message">
                <strong>Motivo:</strong> {{ conversa.transfer_reason }}
            </div>
            {% endif %}
            
            {% if conversa.last_message %}
            <div class="conversa-message">
                <strong>√öltima mensagem:</strong> {{ conversa.last_message[:100] }}{% if conversa.last_message|length > 100 %}...{% endif %}
            </div>
            {% endif %}
            
            <div class="conversa-actions">
                <button class="btn-conversa btn-visualizar" onclick="visualizarChat('{{ conversa._id }}')">
                    üëÅÔ∏è Visualizar Chat
                </button>
                <button class="btn-conversa btn-devolver" onclick="devolverParaIA('{{ conversa._id }}')">
                    ü§ñ Devolver para IA
                </button>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="conversas-empty">
            <div class="conversas-empty-icon">üí¨</div>
            <h3>Nenhuma conversa em atendimento humano</h3>
            <p>Quando um cliente solicitar atendimento humano, ele aparecer√° aqui.</p>
            
            <div class="instrucao-box">
                <h4>üìã Como Testar:</h4>
                <ol>
                    <li>Envie <strong>*</strong> pelo WhatsApp para o bot</li>
                    <li>Aguarde 5 segundos</li>
                    <li>Atualize esta p√°gina (F5)</li>
                    <li>O cliente aparecer√° na lista acima</li>
                </ol>
            </div>
        </div>
    {% endif %}
</div>

<script>
    function visualizarChat(phone) {
        window.location.href = `/admin/atendimento/${phone}`;
    }
    
    async function devolverParaIA(phone) {
        if (!confirm(`Deseja devolver o cliente ${phone} para atendimento autom√°tico?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/admin/atendimento/return-to-ia/${phone}`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                alert('‚úÖ Cliente devolvido para IA com sucesso!\n\nUma mensagem autom√°tica foi enviada para o WhatsApp do cliente.');
                location.reload();
            } else {
                alert('‚ùå Erro ao devolver para IA: ' + data.message);
            }
        } catch (error) {
            alert('‚ùå Erro ao processar: ' + error);
        }
    }
    
    // Auto-refresh a cada 30 segundos
    setInterval(() => {
        location.reload();
    }, 30000);
</script>
{% endblock %}
