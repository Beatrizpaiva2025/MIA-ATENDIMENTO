{% extends "admin_base.html" %}

{% block title %}TransferÃªncias - Painel Administrativo{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ðŸ”„ TransferÃªncias para Atendimento Humano</h2>
        <button class="btn btn-primary" onclick="atualizarLista()">
            <i class="bi bi-arrow-clockwise"></i> Atualizar
        </button>
    </div>

    <!-- EstatÃ­sticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">TransferÃªncias Hoje</h5>
                    <p class="card-text display-4" id="transferenciasHoje">-</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-body">
                    <h5 class="card-title">Aguardando Atendente</h5>
                    <p class="card-text display-4" id="aguardando">-</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">Em Atendimento</h5>
                    <p class="card-text display-4" id="emAtendimento">-</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title">Tempo MÃ©dio Espera</h5>
                    <p class="card-text display-4" id="tempoMedioEspera">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label for="filtroStatus" class="form-label">Status:</label>
                    <select class="form-select" id="filtroStatus" onchange="filtrarTransferencias()">
                        <option value="todos">Todos</option>
                        <option value="aguardando">Aguardando Atendente</option>
                        <option value="em_atendimento">Em Atendimento</option>
                        <option value="finalizado">Finalizado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filtroMotivo" class="form-label">Motivo:</label>
                    <select class="form-select" id="filtroMotivo" onchange="filtrarTransferencias()">
                        <option value="todos">Todos</option>
                        <option value="solicitacao_cliente">SolicitaÃ§Ã£o do Cliente</option>
                        <option value="complexidade">Alta Complexidade</option>
                        <option value="urgente">Urgente</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filtroData" class="form-label">PerÃ­odo:</label>
                    <select class="form-select" id="filtroData" onchange="filtrarTransferencias()">
                        <option value="hoje" selected>Hoje</option>
                        <option value="semana">Esta Semana</option>
                        <option value="mes">Este MÃªs</option>
                        <option value="todos">Todos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="busca" class="form-label">Buscar:</label>
                    <input type="text" class="form-control" id="busca" placeholder="Cliente ou telefone..." onkeyup="filtrarTransferencias()">
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de TransferÃªncias -->
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Lista de TransferÃªncias</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Cliente</th>
                            <th>Telefone</th>
                            <th>Motivo</th>
                            <th>Status</th>
                            <th>Atendente</th>
                            <th>Tempo Espera</th>
                            <th>AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody id="transferenciasTableBody">
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes da TransferÃªncia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDetalhesBody">
                <!-- ConteÃºdo carregado dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-success" onclick="assumirAtendimento()">
                    <i class="bi bi-person-check"></i> Assumir Atendimento
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let transferenciasData = [];
let transferenciaAtual = null;

async function carregarTransferencias() {
    try {
        const response = await fetch('/admin/api/transfers');
        const data = await response.json();
        
        transferenciasData = data.transferencias || [];
        
        // Atualizar estatÃ­sticas
        document.getElementById('transferenciasHoje').textContent = data.hoje || 0;
        document.getElementById('aguardando').textContent = data.aguardando || 0;
        document.getElementById('emAtendimento').textContent = data.em_atendimento || 0;
        document.getElementById('tempoMedioEspera').textContent = (data.tempo_medio_espera || 0) + ' min';
        
        // Atualizar tabela
        filtrarTransferencias();
        
    } catch (error) {
        console.error('Erro ao carregar transferÃªncias:', error);
        document.getElementById('transferenciasTableBody').innerHTML = 
            '<tr><td colspan="8" class="text-center text-danger">Erro ao carregar transferÃªncias</td></tr>';
    }
}

function filtrarTransferencias() {
    const filtroStatus = document.getElementById('filtroStatus').value;
    const filtroMotivo = document.getElementById('filtroMotivo').value;
    const filtroData = document.getElementById('filtroData').value;
    const busca = document.getElementById('busca').value.toLowerCase();
    
    let transferenciasFiltradas = transferenciasData.filter(trans => {
        // Filtro de status
        const passaStatus = filtroStatus === 'todos' || trans.status === filtroStatus;
        
        // Filtro de motivo
        const passaMotivo = filtroMotivo === 'todos' || trans.motivo === filtroMotivo;
        
        // Filtro de data
        const dataTrans = new Date(trans.data_hora);
        const hoje = new Date();
        const inicioSemana = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate() - hoje.getDay());
        const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        
        let passaData = true;
        if (filtroData === 'hoje') passaData = dataTrans.toDateString() === hoje.toDateString();
        else if (filtroData === 'semana') passaData = dataTrans >= inicioSemana;
        else if (filtroData === 'mes') passaData = dataTrans >= inicioMes;
        
        // Filtro de busca
        const passaBusca = busca === '' || 
            trans.cliente.toLowerCase().includes(busca) || 
            trans.telefone.includes(busca);
        
        return passaStatus && passaMotivo && passaData && passaBusca;
    });
    
    atualizarTabela(transferenciasFiltradas);
}

function atualizarTabela(transferencias) {
    const tbody = document.getElementById('transferenciasTableBody');
    
    if (transferencias.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhuma transferÃªncia encontrada</td></tr>';
        return;
    }
    
    tbody.innerHTML = transferencias.map(trans => {
        const tempoEspera = calcularTempoEspera(trans.data_hora, trans.data_atendimento);
        
        return `
            <tr class="${trans.status === 'aguardando' ? 'table-warning' : ''}">
                <td>${new Date(trans.data_hora).toLocaleString('pt-BR')}</td>
                <td>${trans.cliente || 'Sem nome'}</td>
                <td>${trans.telefone}</td>
                <td><span class="badge bg-secondary">${getMotivoLabel(trans.motivo)}</span></td>
                <td>${getStatusBadge(trans.status)}</td>
                <td>${trans.atendente || '-'}</td>
                <td>${tempoEspera}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="verDetalhes('${trans._id}')">
                        <i class="bi bi-eye"></i>
                    </button>
                    ${trans.status === 'aguardando' ? `
                        <button class="btn btn-sm btn-success" onclick="assumirAtendimentoRapido('${trans._id}')">
                            <i class="bi bi-person-check"></i>
                        </button>
                    ` : ''}
                    <button class="btn btn-sm btn-info" onclick="abrirWhatsApp('${trans.telefone}')">
                        <i class="bi bi-whatsapp"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function getStatusBadge(status) {
    const badges = {
        'aguardando': '<span class="badge bg-warning">Aguardando</span>',
        'em_atendimento': '<span class="badge bg-success">Em Atendimento</span>',
        'finalizado': '<span class="badge bg-secondary">Finalizado</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">-</span>';
}

function getMotivoLabel(motivo) {
    const labels = {
        'solicitacao_cliente': 'SolicitaÃ§Ã£o do Cliente',
        'complexidade': 'Alta Complexidade',
        'urgente': 'Urgente',
        'outros': 'Outros'
    };
    return labels[motivo] || motivo;
}

function calcularTempoEspera(dataHora, dataAtendimento) {
    const inicio = new Date(dataHora);
    const fim = dataAtendimento ? new Date(dataAtendimento) : new Date();
    const diffMs = fim - inicio;
    const minutos = Math.floor(diffMs / 60000);
    
    if (minutos < 60) return `${minutos} min`;
    const horas = Math.floor(minutos / 60);
    const mins = minutos % 60;
    return `${horas}h ${mins}m`;
}

async function verDetalhes(transId) {
    try {
        transferenciaAtual = transferenciasData.find(t => t._id === transId);
        if (!transferenciaAtual) return;
        
        const modalBody = document.getElementById('modalDetalhesBody');
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>InformaÃ§Ãµes do Cliente:</h6>
                    <p><strong>Nome:</strong> ${transferenciaAtual.cliente || 'Sem nome'}</p>
                    <p><strong>Telefone:</strong> ${transferenciaAtual.telefone}</p>
                    <p><strong>Data/Hora:</strong> ${new Date(transferenciaAtual.data_hora).toLocaleString('pt-BR')}</p>
                </div>
                <div class="col-md-6">
                    <h6>Detalhes da TransferÃªncia:</h6>
                    <p><strong>Motivo:</strong> ${getMotivoLabel(transferenciaAtual.motivo)}</p>
                    <p><strong>Status:</strong> ${getStatusBadge(transferenciaAtual.status)}</p>
                    <p><strong>Atendente:</strong> ${transferenciaAtual.atendente || 'Nenhum'}</p>
                    <p><strong>Tempo de Espera:</strong> ${calcularTempoEspera(transferenciaAtual.data_hora, transferenciaAtual.data_atendimento)}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Mensagem do Cliente:</h6>
                    <div class="alert alert-info">
                        ${transferenciaAtual.mensagem_cliente || 'Nenhuma mensagem registrada'}
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6>HistÃ³rico da Conversa (antes da transferÃªncia):</h6>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                        ${transferenciaAtual.historico ? transferenciaAtual.historico.map(msg => `
                            <div class="mb-2">
                                <strong style="color: ${msg.tipo === 'user' ? '#6c5ce7' : '#2ecc71'}">
                                    ${msg.tipo === 'user' ? 'Cliente' : 'IA Mia'}:
                                </strong>
                                <p style="margin: 5px 0;">${msg.texto}</p>
                                <small class="text-muted">${new Date(msg.data).toLocaleString('pt-BR')}</small>
                            </div>
                            <hr>
                        `).join('') : '<p class="text-muted">Nenhum histÃ³rico disponÃ­vel</p>'}
                    </div>
                </div>
            </div>
            ${transferenciaAtual.observacoes ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>ObservaÃ§Ãµes:</h6>
                        <p>${transferenciaAtual.observacoes}</p>
                    </div>
                </div>
            ` : ''}
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
        modal.show();
        
    } catch (error) {
        console.error('Erro ao carregar detalhes:', error);
        alert('Erro ao carregar detalhes da transferÃªncia');
    }
}

async function assumirAtendimento() {
    if (!transferenciaAtual) return;
    
    const nomeAtendente = prompt('Digite seu nome:');
    if (!nomeAtendente) return;
    
    try {
        const response = await fetch(`/admin/api/transfers/${transferenciaAtual._id}/assumir`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({atendente: nomeAtendente})
        });
        
        if (response.ok) {
            alert('Atendimento assumido com sucesso!');
            bootstrap.Modal.getInstance(document.getElementById('modalDetalhes')).hide();
            carregarTransferencias();
            
            // Abrir WhatsApp
            window.open(`https://wa.me/${transferenciaAtual.telefone.replace(/\D/g, '')}`, '_blank');
        } else {
            alert('Erro ao assumir atendimento');
        }
    } catch (error) {
        console.error('Erro ao assumir:', error);
        alert('Erro ao assumir atendimento');
    }
}

async function assumirAtendimentoRapido(transId) {
    transferenciaAtual = transferenciasData.find(t => t._id === transId);
    if (!transferenciaAtual) return;
    
    const nomeAtendente = prompt('Digite seu nome:');
    if (!nomeAtendente) return;
    
    try {
        const response = await fetch(`/admin/api/transfers/${transId}/assumir`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({atendente: nomeAtendente})
        });
        
        if (response.ok) {
            alert('Atendimento assumido!');
            carregarTransferencias();
            window.open(`https://wa.me/${transferenciaAtual.telefone.replace(/\D/g, '')}`, '_blank');
        }
    } catch (error) {
        console.error('Erro:', error);
    }
}

function abrirWhatsApp(telefone) {
    window.open(`https://wa.me/${telefone.replace(/\D/g, '')}`, '_blank');
}

function atualizarLista() {
    carregarTransferencias();
}

// Carregar ao iniciar
carregarTransferencias();

// Atualizar a cada 30 segundos (transferÃªncias precisam atualizar mais rÃ¡pido)
setInterval(carregarTransferencias, 30000);

// Tocar som quando houver nova transferÃªncia aguardando
let ultimaContagemAguardando = 0;
setInterval(() => {
    const aguardandoAtual = parseInt(document.getElementById('aguardando').textContent);
    if (aguardandoAtual > ultimaContagemAguardando) {
        // Poderia adicionar um beep aqui
        console.log('Nova transferÃªncia aguardando!');
    }
    ultimaContagemAguardando = aguardandoAtual;
}, 30000);
</script>
{% endblock %}
