{% extends "admin_base.html" %}

{% block title %}Dashboard - Painel Administrativo{% endblock %}

{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Visão geral e indicadores de performance do sistema.{% endblock %}

{% block content %}

<!-- 1. Cards de Métricas Principais (KPIs) -->
<div class="stats-grid">
    <div class="stat-card">
        <h3><i class="fas fa-dollar-sign"></i> Receita Total</h3>
        <div class="stat-value" id="kpi-receita-total">R$ 0,00</div>
        <div class="stat-icon"><i class="fas fa-wallet"></i></div>
    </div>
    <div class="stat-card">
        <h3><i class="fas fa-users"></i> Novos Leads</h3>
        <div class="stat-value" id="kpi-novos-leads">0</div>
        <div class="stat-icon"><i class="fas fa-user-plus"></i></div>
    </div>
    <div class="stat-card">
        <h3><i class="fas fa-chart-line"></i> Taxa de Conversão</h3>
        <div class="stat-value" id="kpi-taxa-conversao">0%</div>
        <div class="stat-icon"><i class="fas fa-percentage"></i></div>
    </div>
    <div class="stat-card">
        <h3><i class="fas fa-brain"></i> Conhecimentos na IA</h3>
        <div class="stat-value" id="kpi-conhecimentos">{{ knowledge_count }}</div>
        <div class="stat-icon"><i class="fas fa-book"></i></div>
    </div>
</div>

<!-- 2. Gráficos Principais -->
<div class="row">
    <div class="col-lg-7">
        <div class="card">
            <div class="card-header">
                <h2>Relatório de Vendas Mensal</h2>
                <p>Evolução da receita nos últimos meses.</p>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-5">
        <div class="card">
            <div class="card-header">
                <h2>Divisão de Receita</h2>
                <p>Receita por categoria de serviço.</p>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="revenueBreakdownChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 3. Tabela de Atividades Recentes (Exemplo) -->
<div class="card mt-4">
    <div class="card-header">
        <h2>Atividades Recentes</h2>
        <p>Últimas ações e eventos no sistema.</p>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Descrição</th>
                        <th>Data</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="recentActivitiesBody">
                    <!-- Linhas serão preenchidas via JS -->
                    <tr><td colspan="4" class="text-center p-4">Carregando atividades...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Chart.js já está no seu admin_base.html, então podemos usá-lo aqui -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cores do tema para os gráficos
    const legacyColors = {
        navy: '#1e3a5f',
        blue: '#3b7bbf',
        lightBlue: '#5eb3e4',
        skyBlue: '#a8d8f0',
        success: '#28a745',
    };

    // --- Gráfico de Linhas: Relatório de Vendas ---
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'], // Exemplo de dados
            datasets: [{
                label: 'Receita',
                data: [12000, 19000, 15000, 22000, 18000, 25000], // Exemplo de dados
                backgroundColor: 'rgba(59, 123, 191, 0.1)',
                borderColor: legacyColors.blue,
                tension: 0.4,
                fill: true,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });

    // --- Gráfico de Doughnut: Divisão de Receita ---
    const revenueCtx = document.getElementById('revenueBreakdownChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'doughnut',
        data: {
            labels: ['Tradução Juramentada', 'Tradução Simples', 'Revisão', 'Outros'], // Exemplo
            datasets: [{
                label: 'Receita por Serviço',
                data: [15000, 8000, 5000, 2000], // Exemplo
                backgroundColor: [
                    legacyColors.navy,
                    legacyColors.blue,
                    legacyColors.lightBlue,
                    legacyColors.skyBlue
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
        }
    });

    // --- Função para carregar dados do dashboard (KPIs, Tabela) ---
    async function loadDashboardData() {
        // Aqui você faria uma chamada à sua API para buscar os dados reais
        // Ex: const response = await fetch('/admin/api/dashboard');
        // const data = await response.json();
        
        // Simulando dados recebidos:
        const data = {
            receita_total: 45760.50,
            novos_leads: 125,
            taxa_conversao: 15.3,
            atividades: [
                { tipo: 'NOVO LEAD', descricao: 'Cliente "Global Corp" entrou no funil.', data: '2025-11-21 10:30', status: 'contato_inicial' },
                { tipo: 'VENDA', descricao: 'Oportunidade "Tech Solutions" ganha.', data: '2025-11-21 09:45', status: 'ganho' },
                { tipo: 'TREINAMENTO', descricao: 'Novo conhecimento sobre "Preços" adicionado à IA.', data: '2025-11-20 18:00', status: 'concluido' }
            ]
        };

        // Preencher KPIs
        document.getElementById('kpi-receita-total').textContent = `R$ ${data.receita_total.toLocaleString('pt-BR')}`;
        document.getElementById('kpi-novos-leads').textContent = data.novos_leads;
        document.getElementById('kpi-taxa-conversao').textContent = `${data.taxa_conversao}%`;

        // Preencher tabela de atividades
        const activitiesBody = document.getElementById('recentActivitiesBody');
        if (data.atividades && data.atividades.length > 0) {
            activitiesBody.innerHTML = data.atividades.map(act => `
                <tr>
                    <td><span class="badge badge-primary">${act.tipo}</span></td>
                    <td>${act.descricao}</td>
                    <td>${act.data}</td>
                    <td><span class="badge badge-success">${act.status}</span></td>
                </tr>
            `).join('');
        } else {
            activitiesBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Nenhuma atividade recente.</td></tr>';
        }
    }

    loadDashboardData();
});
</script>
{% endblock %}
