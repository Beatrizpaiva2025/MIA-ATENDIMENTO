{% extends "admin_base.html" %}

{% block title %}Leads & Conversions - Legacy Translations{% endblock %}

{% block extra_style %}
<style>
    :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --success-color: #48bb78;
        --warning-color: #ed8936;
        --danger-color: #f56565;
        --text-primary: #2d3748;
        --text-secondary: #718096;
        --bg-card: #ffffff;
        --shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .page-header {
        margin-bottom: 30px;
    }

    .page-header h1 {
        color: var(--text-primary);
        font-size: 32px;
        margin-bottom: 10px;
    }

    .page-header p {
        color: var(--text-secondary);
        font-size: 16px;
    }

    .date-filters {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .date-filters select {
        padding: 10px 15px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        background: white;
        transition: all 0.3s;
    }

    .date-filters select:hover {
        border-color: var(--primary-color);
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: var(--bg-card);
        padding: 25px;
        border-radius: 15px;
        box-shadow: var(--shadow);
        transition: transform 0.3s, box-shadow 0.3s;
    }

    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    .metric-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .metric-title {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .icon-revenue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .icon-leads { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .icon-conversion { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .icon-ticket { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

    .metric-value {
        font-size: 36px;
        font-weight: bold;
        color: var(--text-primary);
        margin-bottom: 10px;
    }

    .metric-change {
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .metric-change.positive { color: var(--success-color); }
    .metric-change.negative { color: var(--danger-color); }
    .metric-change.neutral { color: var(--text-secondary); }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: var(--bg-card);
        padding: 25px;
        border-radius: 15px;
        box-shadow: var(--shadow);
    }

    .chart-header {
        margin-bottom: 20px;
    }

    .chart-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 5px;
    }

    .chart-subtitle {
        font-size: 13px;
        color: var(--text-secondary);
    }

    .funnel-container {
        margin-bottom: 30px;
    }

    .funnel-stage {
        background: white;
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        transition: all 0.3s;
    }

    .funnel-stage:hover {
        transform: translateX(10px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    .funnel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .funnel-name {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .funnel-value {
        font-size: 18px;
        font-weight: bold;
        color: var(--primary-color);
    }

    .funnel-bar {
        height: 8px;
        background: #e2e8f0;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 8px;
    }

    .funnel-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        transition: width 0.5s ease;
    }

    .funnel-percentage {
        font-size: 13px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .kpi-table {
        background: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    .kpi-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .kpi-table th {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
    }

    .kpi-table td {
        padding: 15px;
        border-bottom: 1px solid #e2e8f0;
        font-size: 14px;
    }

    .kpi-table tr:hover {
        background: #f7fafc;
    }

    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
    }

    .status-excellent { background: #c6f6d5; color: #22543d; }
    .status-good { background: #bee3f8; color: #2c5282; }
    .status-warning { background: #feebc8; color: #7c2d12; }
    .status-critical { background: #fed7d7; color: #742a2a; }

    .loading {
        text-align: center;
        padding: 50px;
        color: var(--text-secondary);
        font-size: 18px;
    }

    @media (max-width: 768px) {
        .metrics-grid {
            grid-template-columns: 1fr;
        }
        .charts-grid {
            grid-template-columns: 1fr;
        }
        .page-header h1 {
            font-size: 24px;
        }
        .metric-value {
            font-size: 28px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <h1>üìä Dashboard - Leads & Conversions</h1>
        <p>Real-time metrics and performance tracking - Legacy Translations</p>
    </div>

    <!-- Date Filters -->
    <div class="date-filters">
        <select id="periodFilter" onchange="loadDashboardData()">
            <option value="30" selected>Last 30 days</option>
            <option value="7">Last 7 days</option>
            <option value="90">Last 90 days</option>
        </select>
    </div>

    <!-- Main Metrics -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-title">TOTAL REVENUE</span>
                <div class="metric-icon icon-revenue">üí∞</div>
            </div>
            <div class="metric-value" id="totalRevenue">$0</div>
            <div class="metric-change neutral">
                <span>üíµ From converted leads</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-title">TOTAL LEADS</span>
                <div class="metric-icon icon-leads">üë•</div>
            </div>
            <div class="metric-value" id="totalLeads">0</div>
            <div class="metric-change neutral">
                <span id="convertedLeads">0 converted</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-title">CONVERSION RATE</span>
                <div class="metric-icon icon-conversion">üìà</div>
            </div>
            <div class="metric-value" id="conversionRate">0%</div>
            <div class="metric-change neutral">
                <span>üéØ Lead to customer</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-title">AVERAGE TICKET</span>
                <div class="metric-icon icon-ticket">üé´</div>
            </div>
            <div class="metric-value" id="avgTicket">$0</div>
            <div class="metric-change neutral">
                <span>üìä Per converted lead</span>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üìç Leads by Origin</h3>
                <p class="chart-subtitle">Distribution by traffic source</p>
            </div>
            <canvas id="channelsChart"></canvas>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üí∞ Marketing Investment</h3>
                <p class="chart-subtitle">Last 30 days - Daily trend</p>
            </div>
            <canvas id="marketingCostChart"></canvas>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üëÅÔ∏è Website Analytics</h3>
                <p class="chart-subtitle">Visits & Engagement</p>
            </div>
            <canvas id="websiteChart"></canvas>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üîÑ Daily Conversions</h3>
                <p class="chart-subtitle">Conversion trend - Last 30 days</p>
            </div>
            <canvas id="conversionTrendChart"></canvas>
        </div>
    </div>

    <!-- KPI Table -->
    <div class="kpi-table">
        <table>
            <thead>
                <tr>
                    <th>üéØ Key Performance Indicators (KPIs)</th>
                    <th>Current Value</th>
                    <th>Status</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody id="kpiTableBody">
                <tr><td colspan="4" class="loading">Loading KPIs...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let channelsChart, marketingCostChart, websiteChart, conversionTrendChart;

// Load dashboard data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
});

async function loadDashboardData() {
    const days = document.getElementById('periodFilter').value;
    
    try {
        // Fetch data from API
        const response = await fetch(`/admin/api/dashboard-data?days=${days}`);
        const data = await response.json();
        
        if (data.success) {
            // Update main metrics
            updateMainMetrics(data.lead_stats);
            
            // Update charts
            updateChannelsChart(data.lead_stats.leads_by_origin);
            updateMarketingCharts(data.marketing_stats);
            
            // Update KPI table
            updateKPITable(data.kpis);
        } else {
            console.error('Error loading data:', data.error);
        }
    } catch (error) {
        console.error('Error fetching dashboard data:', error);
    }
}

function updateMainMetrics(leadStats) {
    document.getElementById('totalRevenue').textContent = '$' + leadStats.total_revenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    document.getElementById('totalLeads').textContent = leadStats.total_leads;
    document.getElementById('conversionRate').textContent = leadStats.conversion_rate.toFixed(2) + '%';
    document.getElementById('avgTicket').textContent = '$' + leadStats.avg_ticket.toFixed(2);
    document.getElementById('convertedLeads').textContent = leadStats.converted_leads + ' converted';
}

function updateChannelsChart(leadsByOrigin) {
    const ctx = document.getElementById('channelsChart').getContext('2d');
    
    const labels = Object.keys(leadsByOrigin);
    const dataValues = Object.values(leadsByOrigin);
    const colors = ['#667eea', '#f093fb', '#48bb78', '#ed8936', '#4facfe', '#43e97b'];
    
    if (channelsChart) {
        channelsChart.destroy();
    }
    
    channelsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: dataValues,
                backgroundColor: colors.slice(0, labels.length)
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function updateMarketingCharts(marketingStats) {
    // Prepare data
    const dates = marketingStats.map(s => new Date(s.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
    const metaCosts = marketingStats.map(s => s.meta_ads?.cost || 0);
    const googleCosts = marketingStats.map(s => s.google_ads?.cost || 0);
    const websiteVisits = marketingStats.map(s => s.website?.visits || 0);
    const conversions = marketingStats.map(s => s.conversions?.count || 0);
    
    // Marketing Cost Chart
    const costCtx = document.getElementById('marketingCostChart').getContext('2d');
    if (marketingCostChart) {
        marketingCostChart.destroy();
    }
    
    marketingCostChart = new Chart(costCtx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [
                {
                    label: 'Meta Ads ($)',
                    data: metaCosts,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Google Ads ($)',
                    data: googleCosts,
                    borderColor: '#f093fb',
                    backgroundColor: 'rgba(240, 147, 251, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Website Analytics Chart
    const websiteCtx = document.getElementById('websiteChart').getContext('2d');
    if (websiteChart) {
        websiteChart.destroy();
    }
    
    websiteChart = new Chart(websiteCtx, {
        type: 'bar',
        data: {
            labels: dates,
            datasets: [{
                label: 'Daily Visits',
                data: websiteVisits,
                backgroundColor: '#48bb78'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Conversion Trend Chart
    const conversionCtx = document.getElementById('conversionTrendChart').getContext('2d');
    if (conversionTrendChart) {
        conversionTrendChart.destroy();
    }
    
    conversionTrendChart = new Chart(conversionCtx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Daily Conversions',
                data: conversions,
                borderColor: '#ed8936',
                backgroundColor: 'rgba(237, 137, 54, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updateKPITable(kpis) {
    const tbody = document.getElementById('kpiTableBody');
    
    const kpiData = [
        {
            name: 'Cost per Lead (CPL)',
            value: '$' + kpis.cpl.toFixed(2),
            status: kpis.cpl < 20 ? 'excellent' : kpis.cpl < 30 ? 'good' : 'warning',
            statusText: kpis.cpl < 20 ? 'Excellent' : kpis.cpl < 30 ? 'Good' : 'Needs Improvement',
            description: 'Average cost to acquire one lead'
        },
        {
            name: 'Customer Acquisition Cost (CAC)',
            value: '$' + kpis.cac.toFixed(2),
            status: kpis.cac < 100 ? 'excellent' : kpis.cac < 150 ? 'good' : 'warning',
            statusText: kpis.cac < 100 ? 'Excellent' : kpis.cac < 150 ? 'Good' : 'High',
            description: 'Total cost to acquire a paying customer'
        },
        {
            name: 'Lifetime Value (LTV)',
            value: '$' + kpis.ltv,
            status: kpis.ltv > 300 ? 'excellent' : kpis.ltv > 200 ? 'good' : 'warning',
            statusText: kpis.ltv > 300 ? 'Excellent' : kpis.ltv > 200 ? 'Good' : 'Low',
            description: 'Average revenue per customer lifetime'
        },
        {
            name: 'LTV:CAC Ratio',
            value: kpis.ltv_cac_ratio.toFixed(2) + ':1',
            status: kpis.ltv_cac_ratio > 3 ? 'excellent' : kpis.ltv_cac_ratio > 2 ? 'good' : 'critical',
            statusText: kpis.ltv_cac_ratio > 3 ? 'Healthy' : kpis.ltv_cac_ratio > 2 ? 'Fair' : 'Critical',
            description: 'Customer value vs acquisition cost ratio'
        },
        {
            name: 'Marketing ROI',
            value: kpis.marketing_roi.toFixed(2) + '%',
            status: kpis.marketing_roi > 100 ? 'excellent' : kpis.marketing_roi > 50 ? 'good' : 'warning',
            statusText: kpis.marketing_roi > 100 ? 'Profitable' : kpis.marketing_roi > 50 ? 'Positive' : 'Needs Review',
            description: 'Return on marketing investment'
        }
    ];
    
    tbody.innerHTML = kpiData.map(kpi => `
        <tr>
            <td><strong>${kpi.name}</strong></td>
            <td>${kpi.value}</td>
            <td><span class="status-badge status-${kpi.status}">${kpi.statusText}</span></td>
            <td>${kpi.description}</td>
        </tr>
    `).join('');
}
</script>
{% endblock %}
