{% extends "admin_base.html" %}

{% block title %}Conversations - MIA Admin{% endblock %}

{% block extra_style %}
<style>
    .conversations-header {
        background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }

    .conversations-header h1 {
        margin: 0 0 10px 0;
        font-size: 2em;
    }

    .conversations-header p {
        margin: 0;
        opacity: 0.9;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.3s;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .stat-number {
        font-size: 2.2em;
        font-weight: 700;
        color: #1e3a5f;
        margin: 10px 0;
    }

    .stat-label {
        color: #666;
        font-size: 0.9em;
    }

    .filters-container {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-button {
        padding: 10px 20px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
    }

    .filter-button:hover {
        border-color: #2196f3;
        color: #2196f3;
    }

    .filter-button.active {
        background: #2196f3;
        color: white;
        border-color: #2196f3;
    }

    .conversations-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .conversation-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 20px;
        transition: all 0.3s;
        border-left: 4px solid transparent;
    }

    .conversation-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        transform: translateX(5px);
    }

    .conversation-card.ia-mode {
        border-left-color: #2196f3;
    }

    .conversation-card.human-mode {
        border-left-color: #ff9800;
    }

    .conversation-card.cliente-mode {
        border-left-color: #4caf50;
    }

    .conversation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .conversation-phone {
        font-size: 1.1em;
        font-weight: 600;
        color: #1e3a5f;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .conversation-time {
        color: #999;
        font-size: 0.9em;
    }

    .conversation-badges {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }

    .badge {
        padding: 5px 12px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .badge-ia {
        background: #e3f2fd;
        color: #2196f3;
    }

    .badge-cliente {
        background: #e8f5e9;
        color: #4caf50;
    }

    .badge-human {
        background: #fff3e0;
        color: #ff9800;
    }

    .badge-channel {
        background: #f5f5f5;
        color: #666;
    }

    .conversation-message {
        color: #444;
        line-height: 1.6;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 0.95em;
        margin-bottom: 15px;
    }

    .conversation-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9em;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-visualizar {
        background: #2196f3;
        color: white;
    }

    .btn-visualizar:hover {
        background: #1976d2;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }

    .btn-devolver {
        background: #ff9800;
        color: white;
    }

    .btn-devolver:hover {
        background: #e68900;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
    }

    .btn-transferir {
        background: #4caf50;
        color: white;
    }

    .btn-transferir:hover {
        background: #45a049;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    .empty-state {
        padding: 60px 20px;
        text-align: center;
        color: #999;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .empty-state-icon {
        font-size: 4em;
        margin-bottom: 20px;
    }

    .load-more {
        text-align: center;
        padding: 30px;
    }

    .load-more button {
        padding: 12px 30px;
        background: #2196f3;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .load-more button:hover {
        background: #1976d2;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="conversations-header">
    <h1>üí¨ Conversations</h1>
    <p>Hist√≥rico de todas as conversas do sistema</p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">üìä Total</div>
        <div class="stat-number">{{ total }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">ü§ñ IA</div>
        <div class="stat-number">{{ stats.ia if stats else 0 }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">üë§ Humano</div>
        <div class="stat-number">{{ stats.humano if stats else 0 }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">üì± WhatsApp</div>
        <div class="stat-number">{{ stats.whatsapp if stats else 0 }}</div>
    </div>
</div>

<div class="filters-container">
    <span style="color: #666; font-weight: 600;">üîç Filtrar por:</span>
    <button class="filter-button active" onclick="filterConversations('all')">Todas</button>
    <button class="filter-button" onclick="filterConversations('ia')">ü§ñ IA</button>
    <button class="filter-button" onclick="filterConversations('cliente')">üë§ Cliente</button>
    <button class="filter-button" onclick="filterConversations('human')">üî¥ Humano</button>
</div>

<div class="conversations-list">
    {% if conversas and conversas|length > 0 %}
        {% for conversa in conversas %}
        <div class="conversation-card {% if conversa.role in ['assistant', 'ia'] %}ia-mode{% elif conversa.mode == 'human' %}human-mode{% else %}cliente-mode{% endif %}" data-type="{% if conversa.role in ['assistant', 'ia'] %}ia{% elif conversa.mode == 'human' %}human{% else %}cliente{% endif %}">
            <div class="conversation-header">
                <div class="conversation-phone">
                    üì± {{ conversa.phone }}
                </div>
                <div class="conversation-time">
                    üïê {{ conversa.timestamp.strftime('%d/%m/%Y %H:%M') if conversa.timestamp else 'N/A' }}
                </div>
            </div>
            
            <div class="conversation-badges">
                {% if conversa.role == 'assistant' or conversa.role == 'ia' %}
                <span class="badge badge-ia">ü§ñ Resposta IA</span>
                {% elif conversa.role == 'user' %}
                <span class="badge badge-cliente">üë§ Mensagem Cliente</span>
                {% endif %}
                
                {% if conversa.mode == 'human' %}
                <span class="badge badge-human">üî¥ Atendimento Humano</span>
                {% endif %}
                
                <span class="badge badge-channel">üì± {{ conversa.canal if conversa.canal else 'WhatsApp' }}</span>
            </div>
            
            <div class="conversation-message">
                {{ conversa.message if conversa.message else '[Mensagem vazia]' }}
            </div>
            
            <div class="conversation-actions">
                <button class="btn-action btn-visualizar" onclick="visualizarChat('{{ conversa.phone }}')">
                    üëÅÔ∏è Visualizar Chat
                </button>
                
                {% if conversa.mode == 'human' %}
                <button class="btn-action btn-devolver" onclick="devolverParaIA('{{ conversa.phone }}')">
                    ü§ñ Devolver para IA
                </button>
                {% else %}
                <button class="btn-action btn-transferir" onclick="transferirParaHumano('{{ conversa.phone }}')">
                    üë§ Transferir para Humano
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">üí¨</div>
        <h3>Nenhuma conversa registrada</h3>
        <p>As conversas aparecer√£o aqui conforme os clientes interagirem com o bot.</p>
    </div>
    {% endif %}
</div>

{% if conversas and conversas|length >= 100 %}
<div class="load-more">
    <button onclick="location.reload()">üîÑ Recarregar conversas</button>
</div>
{% endif %}

<script>
    function filterConversations(type) {
        // Remover active de todos os bot√µes
        document.querySelectorAll('.filter-button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Adicionar active no bot√£o clicado
        event.target.classList.add('active');
        
        // Filtrar cards
        document.querySelectorAll('.conversation-card').forEach(card => {
            if (type === 'all') {
                card.style.display = 'block';
            } else {
                if (card.dataset.type === type) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            }
        });
    }
    
    function visualizarChat(phone) {
        window.location.href = `/admin/atendimento/${phone}`;
    }
    
    async function devolverParaIA(phone) {
        if (!confirm(`Deseja devolver o cliente ${phone} para atendimento autom√°tico (IA)?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/admin/atendimento/return-to-ia/${phone}`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                alert('‚úÖ Cliente devolvido para IA com sucesso!\n\nUma mensagem autom√°tica foi enviada para o WhatsApp do cliente.');
                location.reload();
            } else {
                alert('‚ùå Erro ao devolver para IA: ' + data.message);
            }
        } catch (error) {
            alert('‚ùå Erro ao processar: ' + error);
        }
    }
    
    async function transferirParaHumano(phone) {
        const motivo = prompt(`Transferir ${phone} para atendimento humano.\n\nMotivo da transfer√™ncia (opcional):`);
        
        if (motivo === null) return; // Cancelou
        
        try {
            // Atualizar modo no banco de dados
            const response = await fetch(`/admin/atendimento/transfer-to-human/${phone}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ reason: motivo || 'Transfer√™ncia manual via dashboard' })
            });
            
            if (response.ok) {
                alert('‚úÖ Cliente transferido para atendimento humano com sucesso!');
                location.reload();
            } else {
                alert('‚ùå Erro ao transferir. Tente novamente.');
            }
        } catch (error) {
            alert('‚ùå Erro ao processar: ' + error);
        }
    }
    
    // Auto-refresh a cada 30 segundos
    setInterval(() => {
        location.reload();
    }, 30000);
</script>
{% endblock %}
